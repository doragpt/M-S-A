
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>統合ダッシュボード</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
  <!-- Chart.js Crosshair Plugin (FX風チャート用) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@1.2.0/dist/chartjs-plugin-crosshair.min.js"></script>
  <style>
    /* 共通スタイル */
    body {
      background-color: #f7f7f7;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .header {
      background-color: #007bff;
      color: #fff;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .header.dark {
      background-color: #444;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-header {
      font-weight: bold;
      background-color: rgba(0,123,255,0.85);
    }
    .card-body {
      font-size: 1.2rem;
    }
    .tab-pane {
      margin-top: 20px;
    }
    .chart-container {
      position: relative;
      margin: auto;
      height: 400px;
    }
    table.dataTable tbody tr {
      background-color: transparent;
    }
    .store-name.clickable {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .badge {
      font-size: 0.9rem;
    }
    /* ダークモード */
    body.dark {
      background-color: #333;
      color: #eee;
    }
    body.dark .header {
      background-color: #444;
    }
    body.dark .card {
      background-color: #555;
      color: #fff;
    }
    body.dark table.dataTable tbody tr {
      color: #fff;
    }
    .modal-header {
      background-color: #007bff;
      color: #fff;
      border-bottom: none;
    }
    /* Toast 用スタイル */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }
    /* ローディングスピナー */
    #loadingSpinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      display: none;
    }
    #errorContainer {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 10px;
      background-color: red;
      color: white;
      z-index: 2001;
      display: none;
    }
  </style>
</head>
<body>
  <!-- ローディングスピナー -->
  <div id="loadingSpinner">
    <div class="d-flex flex-column align-items-center bg-white p-4 rounded shadow">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mb-0" id="loadingMessage">データを読み込み中です...</p>
      <div class="progress mt-2 w-100" style="display: none;" id="loadingProgress">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- エラー表示コンテナ -->
  <div id="errorContainer"></div>

  <!-- ヘッダー -->
  <div class="header" id="pageHeader">
    <h1>統合ダッシュボード</h1>
    <div class="btn-group">
      <button id="darkModeToggle" class="btn btn-light btn-sm">ダークモード切替</button>
      <button id="favoritesToggle" class="btn btn-light btn-sm">お気に入りのみ表示</button>
    </div>
  </div>

  <div class="container-fluid my-3">
    <!-- メインタブ -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab">店舗稼働状況</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history" role="tab">店舗履歴グラフ（期間指定）</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="hourly-tab" data-bs-toggle="tab" href="#hourly" role="tab">時間帯別分析</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="area-tab" data-bs-toggle="tab" href="#area" role="tab">エリア統計</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="type-tab" data-bs-toggle="tab" href="#type" role="tab">業種内ジャンルランキング</a>
      </li>
      <!-- 新規追加：平均稼働ランキングタブ -->
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="ranking-tab" data-bs-toggle="tab" href="#ranking" role="tab">平均稼働ランキング</a>
      </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="dashboardTabsContent">
      <!-- タブ1: 店舗稼働状況 -->
      <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
        <div class="row my-4">
          <!-- 各カード：店舗数、平均稼働率、最高稼働率 -->
          <div class="col-md-4 mb-3">
            <div class="card text-white bg-primary">
              <div class="card-header">店舗数</div>
              <div class="card-body">
                <h5 id="totalStores" class="card-title">--</h5>
                <p class="card-text">現在データがある店舗数</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card text-white bg-success">
              <div class="card-header">平均稼働率</div>
              <div class="card-body">
                <h5 id="avgRate" class="card-title">--</h5>
                <p class="card-text">勤務中キャストに対する実働率</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card text-white bg-warning">
              <div class="card-header">最高稼働率</div>
              <div class="card-body">
                <h5 id="maxRate" class="card-title">--</h5>
                <p class="card-text">最高の稼働率店舗の稼働率</p>
              </div>
            </div>
          </div>
        </div>
        <!-- 店舗情報テーブル -->
        <div class="row">
          <div class="col">
            <div class="table-responsive">
              <table id="storeTable" class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>選択</th>
                    <th>店舗名</th>
                    <th>業種</th>
                    <th>ジャンル</th>
                    <th>エリア</th>
                    <th>総出勤</th>
                    <th>勤務中人数</th>
                    <th>即ヒメ人数</th>
                    <th>現在稼働率 (%)</th>
                    <th>状態</th>
                    <th>直近1週間の稼働率 (%)</th>
                    <th>直近1か月の稼働率 (%)</th>
                  </tr>
                </thead>
                <tbody id="dataTable"></tbody>
              </table>
            </div>
            <!-- CSVエクスポート・比較分析ボタン -->
            <button id="exportCSV" class="btn btn-secondary mt-2">CSVエクスポート</button>
            <button id="compareBtn" class="btn btn-info mt-2">比較分析</button>
          </div>
        </div>
        <!-- トップ10店舗グラフ -->
        <div class="row my-3">
          <div class="col">
            <div id="top10ChartLoading" style="display: none;">読み込み中...</div>
            <div id="top10ChartContainer">
              <canvas id="currentRateChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ2: 店舗履歴グラフ（期間指定） -->
      <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <div class="my-4">
          <h3>店舗履歴グラフ（期間指定）</h3>
          <div class="row mb-3">
            <div class="col-md-3">
              <label for="storeSelectHistory" class="form-label">店舗選択</label>
              <select id="storeSelectHistory" class="form-select">
                <option value="">全店舗</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="startDate" class="form-label">開始日</label>
              <input type="date" id="startDate" class="form-control" />
            </div>
            <div class="col-md-3">
              <label for="endDate" class="form-label">終了日</label>
              <input type="date" id="endDate" class="form-control" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button id="updateHistoryBtn" class="btn btn-primary w-100">更新</button>
            </div>
          </div>
          
          <!-- 集計結果を先に表示 -->
          <div class="row mb-3">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">集計結果</h5>
                  <p id="historyStats" class="mb-0">--</p>
                  <div class="d-flex justify-content-end mt-3">
                    <button id="historyResetZoomBtn" class="btn btn-sm btn-outline-secondary" style="display: none;">ズームリセット</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- グラフ表示 -->
          <div class="card">
            <div class="card-body">
              <div id="historyChartLoading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary mb-3" role="status">
                  <span class="visually-hidden">読み込み中...</span>
                </div>
                <p>データを読み込み中です...</p>
              </div>
              <div id="historyChartContainer">
                <canvas id="historyChart"></canvas>
              </div>
              <div id="historyChartError" class="alert alert-danger mt-3" style="display: none;">
                データの読み込み中にエラーが発生しました。もう一度お試しください。
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ3: 時間帯別分析 -->
      <div class="tab-pane fade" id="hourly" role="tabpanel" aria-labelledby="hourly-tab">
        <div class="my-4">
          <h3>時間帯別分析</h3>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="hourlyStoreSelect" class="form-label">店舗選択</label>
              <select id="hourlyStoreSelect" class="form-select">
                <option value="">全店舗</option>
              </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button id="updateHourlyBtn" class="btn btn-primary w-100">更新</button>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showPeakHours">
                <label class="form-check-label" for="showPeakHours">
                  ピーク時間帯をハイライト
                </label>
              </div>
            </div>
          </div>
          
          <!-- 集計結果を先に表示 -->
          <div class="row mb-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">集計結果</h5>
                  <p id="hourlyStats" class="mb-0">--</p>
                  <div id="peakHoursInfo" class="mt-2 small text-muted" style="display: none;">
                    ピーク時間帯: <span id="peakHoursRange">--</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- グラフを後に表示 -->
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body">
                  <div id="hourlyAnalysisLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-success mb-3" role="status">
                      <span class="visually-hidden">読み込み中...</span>
                    </div>
                    <p>時間帯別データを分析中...</p>
                  </div>
                  <div id="hourlyAnalysisContainer" class="chart-container" style="height: 400px;">
                    <canvas id="hourlyChart"></canvas>
                  </div>
                  <div id="hourlyAnalysisError" class="alert alert-danger mt-3" style="display: none;">
                    データの分析中にエラーが発生しました。もう一度お試しください。
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ4: エリア統計 -->
      <div class="tab-pane fade" id="area" role="tabpanel" aria-labelledby="area-tab">
        <div class="my-4">
          <h2 class="mb-4 text-center">エリア統計</h2>
          <div class="table-responsive mb-3">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>エリア</th>
                  <th>店舗数</th>
                  <th>平均稼働率 (%)</th>
                </tr>
              </thead>
              <tbody id="areaTable"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="card-body">
              <canvas id="areaChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ5: 業種内ジャンルランキング -->
      <div class="tab-pane fade" id="type" role="tabpanel" aria-labelledby="type-tab">
        <div class="my-4">
          <h2 class="mb-4 text-center">業種内ジャンルランキング</h2>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="industrySelectType" class="form-label">業種を選択</label>
              <select id="industrySelectType" class="form-select"></select>
            </div>
            <div class="col-md-6">
              <div class="spinner-border text-primary" role="status" style="display:none;">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="table-responsive mb-3">
            <table id="typeTable" class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>順位</th>
                  <th>ジャンル</th>
                  <th>店舗数</th>
                  <th>平均稼働率 (%)</th>
                </tr>
              </thead>
              <tbody id="typeTableBody"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="card-body">
              <canvas id="typeChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ6: 平均稼働ランキング -->
      <div class="tab-pane fade" id="ranking" role="tabpanel" aria-labelledby="ranking-tab">
        <div class="my-4">
          <h2 class="mb-4 text-center">平均稼働ランキング</h2>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="rankingTypeSelect" class="form-label">ランキングタイプ</label>
              <select id="rankingTypeSelect" class="form-select">
                <option value="all" selected>全店舗</option>
                <option value="industry">業種別</option>
              </select>
            </div>
            <div class="col-md-6" id="industryFilterDiv" style="display: none;">
              <label for="industrySelectRanking" class="form-label">業種を選択</label>
              <select id="industrySelectRanking" class="form-select">
                <!-- JSで動的に追加 -->
              </select>
              <div class="spinner-border text-primary" role="status" style="display:none;">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <button id="updateRankingBtn" class="btn btn-primary">ランキング更新</button>
          </div>
          <div class="table-responsive">
            <div id="averageRankingLoading" style="display: none;">読み込み中...</div>
            <div id="averageRankingContainer">
              <table id="rankingTable" class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>順位</th>
                    <th>店舗名</th>
                    <th>業種</th>
                    <th>ジャンル</th>
                    <th>エリア</th>
                    <th>平均稼働率 (%)</th>
                  </tr>
                </thead>
                <tbody id="rankingTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- /tab-content -->
  </div> <!-- /container-fluid -->

  <!-- 店舗詳細モーダル -->
  <div class="modal fade" id="storeDetailModal" tabindex="-1" aria-labelledby="storeDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="storeDetailModalLabel">店舗詳細</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <div id="storeDetailBasic"></div>
          <hr />
          <!-- モーダル内タブ：履歴グラフ・時間帯別分析 -->
          <ul class="nav nav-tabs" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="detail-history-tab" data-bs-toggle="tab" href="#detailHistory" role="tab">履歴グラフ</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="detail-hourly-tab" data-bs-toggle="tab" href="#detailHourly" role="tab">時間帯分析</a>
            </li>
          </ul>
          <div class="tab-content" id="detailTabsContent">
            <div class="tab-pane fade show active" id="detailHistory" role="tabpanel" aria-labelledby="detail-history-tab">
              <div class="chart-container">
                <canvas id="detailHistoryChart"></canvas>
              </div>
            </div>
            <div class="tab-pane fade" id="detailHourly" role="tabpanel" aria-labelledby="detail-hourly-tab">
              <div class="chart-container">
                <canvas id="detailHourlyChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 比較分析モーダル -->
  <div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="compareModalLabel">店舗比較分析</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <canvas id="compareChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast通知用コンテナ -->
  <div class="toast-container">
    <div id="updateToast" class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">新しいデータに更新しました！</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- jQuery, DataTables, Bootstrap JS, Socket.IO -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>

  <script>
    (function () {
      document.addEventListener("DOMContentLoaded", async () => {

        // ローディングスピナー操作関数
        function showSpinner() { document.getElementById("loadingSpinner").style.display = "block"; }
        function hideSpinner() { document.getElementById("loadingSpinner").style.display = "none"; }

        /***********************************************
         * fetchWithRetry: API呼び出しのリトライ処理
         ***********************************************/
        async function fetchWithRetry(url, options = {}, maxRetries = 3, delay = 2000) {
          let currentRetry = 0;

          while (currentRetry < maxRetries) {
            try {
              const response = await fetch(url, options);
              if (!response.ok) throw new Error(`HTTP error ${response.status}`);

              // データをパースして返す
              return await response.json();
            } catch (error) {
              currentRetry++;
              console.error(`Fetch error (${url}), attempt ${currentRetry}: ${error}`);
              if (currentRetry >= maxRetries) {
                throw error;
              }
              // Wait before retrying
              await new Promise(r => setTimeout(r, delay));
            }
          }
        }

        /***********************************************
         * グローバル変数と初期設定
         ***********************************************/
        const charts = {
          currentRate: null,
          history: null,
          hourly: null,
          area: null,
          type: null,
          detailHistory: null,
          detailHourly: null,
          compare: null
        };
        let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
        let favoritesFilterActive = false;
        const savedIndustry = localStorage.getItem("industryFilter") || "";
        const savedHistoryStore = localStorage.getItem("historyStoreFilter") || "";
        const savedHourlyStore = localStorage.getItem("hourlyStoreFilter") || "";

        /***********************************************
         * ダークモード & お気に入りフィルタ
         ***********************************************/
        document.getElementById("darkModeToggle")?.addEventListener("click", () => {
          document.body.classList.toggle("dark");
          document.getElementById("pageHeader")?.classList.toggle("dark");
        });
        document.getElementById("favoritesToggle")?.addEventListener("click", () => {
          const rows = document.querySelectorAll("#storeTable tbody tr");
          favoritesFilterActive = !favoritesFilterActive;
          rows.forEach((row) => {
            const storeName = row.cells[1].innerText.trim();
            row.style.display = (favoritesFilterActive && !favorites.includes(storeName)) ? "none" : "";
          });
          document.getElementById("favoritesToggle").innerText = favoritesFilterActive ? "すべて表示" : "お気に入りのみ表示";
        });

        /***********************************************
         * CSVエクスポート機能
         ***********************************************/
        document.getElementById("exportCSV")?.addEventListener("click", () => {
          const rows = Array.from(document.querySelectorAll("#storeTable tr"));
          const csvContent = rows.map(row => Array.from(row.cells).map(cell => `"${cell.innerText.trim().replace(/"/g, '""')}"`).join(",")).join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "store_data.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        /***********************************************
         * updateDashboard: 店舗稼働状況更新 (/api/data)
         ***********************************************/
        async function updateDashboard() {
          try {
            // ページネーションなしで全データを取得（pageパラメータを指定しない）
            const responseJson = await fetchWithRetry("/api/data", {}, 3, 2000);
            const data = responseJson.data || responseJson; // 新旧APIの両方に対応

            // APIからメタデータを取得（バックエンドで計算された集計値）
            const meta = responseJson.meta || {}; 

            // 店舗数の表示（APIのメタデータから）
            document.getElementById("totalStores").innerText = meta.total_count || data.length;

            // 平均稼働率の表示（APIのメタデータから）
            document.getElementById("avgRate").innerText = (meta.avg_rate || 0).toFixed(1) + "%";

            // 最高稼働率の表示（APIのメタデータから）
            document.getElementById("maxRate").innerText = (meta.max_rate || 0).toFixed(1) + "%";

            const tableBody = document.getElementById("dataTable");
            tableBody.innerHTML = "";
            data.forEach((store) => {
              const rate = store.working_staff > 0 ? ((store.working_staff - store.active_staff) / store.working_staff * 100) : 0;
              const rateStr = rate.toFixed(1);
              const tagHtml = rate >= 50
                ? '<span class="badge bg-danger">高稼働</span>'
                : '<span class="badge bg-secondary">低稼働</span>';
              const isFav = favorites.includes(store.store_name);
              const rowHtml = `
                <tr>
                  <td>
                    <button class="favorite-btn btn btn-sm ${isFav ? "btn-warning" : "btn-outline-warning"}" data-store-name="${store.store_name}">★</button>
                    <input type="checkbox" class="compare-checkbox" data-store-name="${store.store_name}">
                  </td>
                  <td class="store-name clickable" data-store='${encodeURIComponent(JSON.stringify(store))}'>${store.store_name}</td>
                  <td>${store.biz_type || ""}</td>
                  <td>${store.genre || ""}</td>
                  <td>${store.area || ""}</td>
                  <td>${store.total_staff}</td>
                  <td>${store.working_staff}</td>
                  <td>${store.active_staff}</td>
                  <td>${rateStr}</td>
                  <td>${tagHtml}</td>
                  <td>--</td>
                  <td>--</td>
                </tr>`;
              tableBody.insertAdjacentHTML("beforeend", rowHtml);
            });
            if ($.fn.dataTable.isDataTable("#storeTable")) {
              $("#storeTable").DataTable().destroy();
            }
            $("#storeTable").DataTable({
              responsive: true,
              order: [[8, "desc"]],
              language: { search: "検索:" }
            });
            $("#storeTable tbody").off("click", ".favorite-btn").on("click", ".favorite-btn", function (e) {
              e.stopPropagation();
              const storeName = $(this).data("store-name");
              if (favorites.includes(storeName)) {
                favorites = favorites.filter(n => n !== storeName);
                $(this).removeClass("btn-warning").addClass("btn-outline-warning");
              } else {
                favorites.push(storeName);
                $(this).removeClass("btn-outline-warning").addClass("btn-warning");
              }
              localStorage.setItem("favorites", JSON.stringify(favorites));
            });
            $("#storeTable tbody").off("click", ".store-name.clickable").on("click", ".store-name.clickable", function () {
              const store = JSON.parse(decodeURIComponent($(this).data("store")));
              const content = `
                <strong>店舗名:</strong> ${store.store_name}<br>
                <strong>業種:</strong> ${store.biz_type || "不明"}<br>
                <strong>ジャンル:</strong> ${store.genre || "不明"}<br>
                <strong>エリア:</strong> ${store.area || "不明"}<br>
                <strong>総出勤:</strong> ${store.total_staff}<br>
                <strong>勤務中人数:</strong> ${store.working_staff}<br>
                <strong>即ヒメ人数:</strong> ${store.active_staff}<br>
                <strong>店舗URL:</strong> <a href="${store.url}" target="_blank">${store.url}</a>
              `;
              $("#storeDetailBasic").html(content);
              updateDetailHistoryChart(store.store_name);
              updateDetailHourlyChart(store.store_name);
              new bootstrap.Modal(document.getElementById("storeDetailModal")).show();
            });
          } catch (error) {
            console.error("APIデータ取得エラー:", error);
            handleError(error, "updateDashboard");
          }
        }

        /***********************************************
         * updateTop10Chart: トップ10店舗グラフ更新 (/api/data)
         ***********************************************/
        async function updateTop10Chart() {
          const loadingElement = document.getElementById('top10ChartLoading');
          const containerElement = document.getElementById('top10ChartContainer');

          if (!loadingElement || !containerElement) {
            console.error('Top10 chart elements not found in the DOM');
            return;
          }

          loadingElement.style.display = 'block';
          containerElement.style.display = 'none';

          try {
            const responseJson = await fetchWithRetry("/api/ranking/top", {}, 3, 2000);
            // Handle both formats - direct array or { data: [...] } object
            const data = Array.isArray(responseJson) ? responseJson : (responseJson.data || []);

            data.forEach(store => {
              store.currentRate = store.working_staff > 0 ? ((store.working_staff - store.active_staff) / store.working_staff * 100).toFixed(1) : 0;
            });
            const topData = data.sort((a, b) => b.currentRate - a.currentRate).slice(0, 10);
            const labels = topData.map(store => store.store_name);
            const rates = topData.map(store => store.currentRate);
            const ctx = document.getElementById("currentRateChart").getContext("2d");
            if (charts.currentRate) charts.currentRate.destroy();
            charts.currentRate = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [{
                  label: "現在稼働率 (%)",
                  data: rates,
                  backgroundColor: "rgba(75, 192, 192, 0.7)",
                  borderColor: "rgba(75, 192, 192, 1)",
                  borderWidth: 1
                }]
              },
              options: {
                indexAxis: "y",
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: "トップ10店舗の現在稼働率",
                    font: { size: 20 }
                  },
                  tooltip: { callbacks: { label: context => `${context.parsed.x}%` } },
                  zoom: {
                    pan: { enabled: true, mode: 'xy' },
                    zoom: { 
                      wheel: { enabled: true },
                      drag: { enabled: true },
                      mode: 'xy'
                    }
                  },
                  legend: { display: false }
                },
                scales: {
                  x: { beginAtZero: true, max: 100, title: { display: true, text: "稼働率(%)" } },
                  y: { ticks: { font: { size: 12 } } }
                },
                animation: { duration: 1000 }
              }
            });
          } catch (error) {
            console.error("トップ10店舗グラフエラー:", error);
            handleError(error, "updateTop10Chart");
          } finally {
            // 要素が存在する場合のみ表示状態を変更
            if (loadingElement) loadingElement.style.display = 'none';
            if (containerElement) containerElement.style.display = 'block';
          }
        }

        /***********************************************
         * updateHistoryChart: 店舗履歴グラフ更新 (/api/history or /api/aggregated)
         ***********************************************/
        let historyChartCache = {}; // キャッシュ用オブジェクト

        async function updateHistoryChart() {
          const loadingElement = document.getElementById('historyChartLoading');
          const containerElement = document.getElementById('historyChartContainer');
          const errorElement = document.getElementById('historyChartError');
          const resetZoomBtn = document.getElementById('historyResetZoomBtn');
          const historyStats = document.getElementById("historyStats");

          if (!loadingElement || !containerElement) {
            console.error('History chart elements not found in the DOM');
            return;
          }

          // 表示状態の初期化
          loadingElement.style.display = 'block';
          containerElement.style.display = 'none';
          if (errorElement) errorElement.style.display = 'none';
          if (resetZoomBtn) resetZoomBtn.style.display = 'none';
          if (historyStats) historyStats.textContent = "データを読み込み中...";

          try {
            const storeSelect = document.getElementById("storeSelectHistory");
            const selectedStore = storeSelect ? storeSelect.value : "";
            const startDate = document.getElementById("startDate")?.value || "";
            const endDate = document.getElementById("endDate")?.value || "";

            // キャッシュキーを作成
            const cacheKey = `${selectedStore}_${startDate}_${endDate}`;

            // キャッシュがあれば使用
            if (historyChartCache[cacheKey]) {
              const cachedData = historyChartCache[cacheKey];
              updateHistoryChartDisplay(cachedData);
              loadingElement.style.display = 'none';
              containerElement.style.display = 'block';
              return;
            }

            // パラメータを設定
            let url = "/api/history/optimized?";
            const params = new URLSearchParams();
            
            if (selectedStore) params.append("store", selectedStore);
            if (startDate) params.append("start_date", startDate);
            if (endDate) params.append("end_date", endDate);
            
            // データ取得
            const data = await fetchWithRetry(url + params.toString(), {}, 3, 2000);
            
            // データが空の場合
            if (!data || !Array.isArray(data) || data.length === 0) {
              throw new Error("該当するデータが見つかりませんでした");
            }

            // データをグループ化して処理
            const processedData = processHistoryData(data, selectedStore);
            
            // キャッシュに保存
            historyChartCache[cacheKey] = processedData;
            
            // チャート表示
            updateHistoryChartDisplay(processedData);
            
          } catch (error) {
            console.error("履歴データ取得エラー:", error);
            
            // エラー表示
            if (errorElement) {
              errorElement.textContent = error.message || "データの取得中にエラーが発生しました";
              errorElement.style.display = 'block';
            }
            
            // 統計情報エリアにもエラーを表示
            if (historyStats) {
              historyStats.textContent = "選択された条件に一致するデータがありません。別の期間や店舗を選択してください。";
            }
            
            // 空のチャートを表示
            if (charts.history) charts.history.destroy();
            if (document.getElementById("historyChart")) {
              const ctx = document.getElementById("historyChart").getContext("2d");
              charts.history = new Chart(ctx, {
                type: "line",
                data: {
                  labels: ["データなし"],
                  datasets: [{
                    label: "実働率 (%)",
                    data: [0],
                    borderColor: "rgba(200, 200, 200, 0.5)",
                    backgroundColor: "rgba(200, 200, 200, 0.1)",
                    fill: false
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: {
                      display: true,
                      text: selectedStore ? 
                        `店舗「${selectedStore}」のデータが見つかりません` : 
                        "指定期間のデータが見つかりません",
                      font: { size: 18, weight: 'bold' }
                    },
                    subtitle: {
                      display: true,
                      text: "検索条件を変更してください",
                      font: { size: 14 }
                    }
                  }
                }
              });
            }
          } finally {
            // ローディング表示を非表示に
            if (loadingElement) loadingElement.style.display = 'none';
            if (containerElement) containerElement.style.display = 'block';
          }
        }

        // 履歴データの処理関数
        function processHistoryData(data, selectedStore) {
          // 単一店舗の場合と全店舗の場合で処理を分ける
          if (selectedStore) {
            // 単一店舗の場合: 時間順にソート
            data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const labels = data.map(record => {
              const d = new Date(record.timestamp);
              return d.toLocaleDateString() + " " + d.toTimeString().substring(0, 5);
            });
            
            const rates = data.map(record => {
              if (record.rate) return parseFloat(record.rate);
              if (record.working_staff > 0) {
                return (record.working_staff - record.active_staff) / record.working_staff * 100;
              }
              return 0;
            });
            
            return {
              labels,
              rates,
              rawData: data,
              selectedStore,
              stats: calculateStats(rates)
            };
          } else {
            // 全店舗の場合: 日付単位で集計
            const dateMap = new Map();
            
            data.forEach(record => {
              if (!record || !record.timestamp) return;
              
              const d = new Date(record.timestamp);
              const dateKey = d.toLocaleDateString();
              
              if (!dateMap.has(dateKey)) {
                dateMap.set(dateKey, { sum: 0, count: 0 });
              }
              
              const rate = record.rate ? parseFloat(record.rate) :
                (record.working_staff > 0 ? 
                  ((record.working_staff - record.active_staff) / record.working_staff * 100) : 0);
              
              if (rate > 0) {
                dateMap.get(dateKey).sum += rate;
                dateMap.get(dateKey).count += 1;
              }
            });
            
            // 日付でソート
            const sortedDates = Array.from(dateMap.keys()).sort((a, b) => 
              new Date(a) - new Date(b)
            );
            
            const labels = sortedDates;
            const rates = sortedDates.map(date => {
              const entry = dateMap.get(date);
              return entry.count > 0 ? entry.sum / entry.count : 0;
            });
            
            return {
              labels,
              rates,
              rawData: data,
              selectedStore: "",
              stats: calculateStats(rates)
            };
          }
        }

        // 統計情報の計算
        function calculateStats(rates) {
          if (!rates || rates.length === 0) return null;
          
          const numericRates = rates.map(r => parseFloat(r));
          const validRates = numericRates.filter(r => !isNaN(r));
          
          if (validRates.length === 0) return null;
          
          const sum = validRates.reduce((a, b) => a + b, 0);
          return {
            count: validRates.length,
            avg: sum / validRates.length,
            max: Math.max(...validRates),
            min: Math.min(...validRates),
            latest: validRates[validRates.length - 1]
          };
        }

        // チャート表示処理
        function updateHistoryChartDisplay(data) {
          if (!data) return;
          
          const ctx = document.getElementById("historyChart").getContext("2d");
          const resetZoomBtn = document.getElementById('historyResetZoomBtn');
          const historyStats = document.getElementById("historyStats");
          
          if (charts.history) charts.history.destroy();

          // 数値データへの変換
          const numericRates = data.rates.map(r => parseFloat(r));
          
          // トレンドラインの作成（移動平均）
          let trendlineData = [];
          if (numericRates.length > 5) {
            const windowSize = Math.min(5, Math.floor(numericRates.length / 3));
            for (let i = 0; i < numericRates.length; i++) {
              if (i < windowSize - 1) {
                trendlineData.push(numericRates[i]);
              } else {
                let sum = 0;
                for (let j = 0; j < windowSize; j++) {
                  sum += numericRates[i - j];
                }
                trendlineData.push(sum / windowSize);
              }
            }
          }

          // カラー設定
          const borderColor = data.selectedStore ? "rgba(33, 150, 243, 1)" : "rgba(76, 175, 80, 1)";
          const backgroundColor = data.selectedStore ? "rgba(33, 150, 243, 0.1)" : "rgba(76, 175, 80, 0.1)";

          // データセット
          const datasets = [
            {
              label: "実働率 (%)",
              data: numericRates,
              borderColor: borderColor,
              backgroundColor: backgroundColor,
              borderWidth: 2,
              fill: true,
              tension: 0.2,
              pointRadius: data.labels.length > 100 ? 0 : 2,
              pointHoverRadius: 6,
              pointBackgroundColor: borderColor,
              pointBorderColor: "#fff",
              pointBorderWidth: 2
            }
          ];

          // トレンドラインをデータセットに追加
          if (trendlineData.length > 5) {
            datasets.push({
              label: "トレンド",
              data: trendlineData,
              borderColor: "rgba(255, 159, 64, 0.8)",
              backgroundColor: "rgba(255, 159, 64, 0)",
              borderWidth: 1.5,
              borderDash: [5, 5],
              fill: false,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 0
            });
          }

          // チャート作成
          charts.history = new Chart(ctx, {
            type: "line",
            data: {
              labels: data.labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                title: {
                  display: true,
                  text: (data.selectedStore === "") 
                        ? "全店舗の平均稼働率（期間指定）"
                        : `店舗「${data.selectedStore}」の履歴グラフ`,
                  font: { size: 20, weight: 'bold' }
                },
                tooltip: { 
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleFont: { weight: 'bold' },
                  bodyFont: { size: 14 },
                  padding: 10,
                  callbacks: { 
                    label: context => `稼働率: ${context.parsed.y.toFixed(1)}%` 
                  } 
                },
                zoom: {
                  pan: { 
                    enabled: true,
                    mode: 'xy',
                    threshold: 5
                  },
                  zoom: { 
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'xy',
                    onZoomComplete: function() {
                      if (resetZoomBtn) resetZoomBtn.style.display = 'block';
                    }
                  }
                },
                crosshair: {
                  line: {
                    color: 'rgba(100, 100, 100, 0.4)',
                    width: 1,
                    dashPattern: [5, 5]
                  },
                  sync: {
                    enabled: true
                  },
                  zoom: {
                    enabled: false
                  }
                }
              },
              scales: {
                y: { 
                  beginAtZero: true, 
                  max: Math.min(Math.ceil(Math.max(...numericRates) * 1.1), 100), 
                  title: { 
                    display: true, 
                    text: "実働率 (%)",
                    font: { 
                      weight: 'bold',
                      size: 14
                    }
                  },
                  grid: {
                    color: 'rgba(200, 200, 200, 0.3)',
                    lineWidth: 1,
                    drawBorder: true,
                    drawTicks: true
                  },
                  ticks: {
                    font: { size: 12 },
                    padding: 5
                  }
                },
                x: { 
                  title: { 
                    display: true, 
                    text: "日時",
                    font: { 
                      weight: 'bold',
                      size: 14
                    }
                  },
                  grid: {
                    color: 'rgba(200, 200, 200, 0.3)',
                    lineWidth: 1,
                    drawBorder: true,
                    drawTicks: true
                  },
                  ticks: {
                    maxTicksLimit: Math.min(Math.ceil(data.labels.length / 5), 15),
                    font: { size: 11 },
                    padding: 5,
                    maxRotation: 45,
                    minRotation: 45
                  }
                }
              },
              animation: { duration: 400 },
              elements: {
                line: {
                  tension: 0.3
                }
              }
            }
          });

          // ズームリセットボタンのイベントハンドラ
          if (resetZoomBtn) {
            resetZoomBtn.style.display = 'none'; // 初期状態は非表示
            resetZoomBtn.onclick = function() {
              if (charts.history) {
                charts.history.resetZoom();
                resetZoomBtn.style.display = 'none';
              }
            };
          }

          // 統計情報の表示
          if (historyStats && data.stats) {
            const stats = data.stats;
            historyStats.innerHTML = `
              <div class="d-flex flex-wrap justify-content-between">
                <div><strong>期間内サンプル数:</strong> ${stats.count}</div>
                <div><strong>平均稼働率:</strong> ${stats.avg.toFixed(1)}%</div>
                <div><strong>最高稼働率:</strong> ${stats.max.toFixed(1)}%</div>
                <div><strong>最低稼働率:</strong> ${stats.min.toFixed(1)}%</div>
                <div><strong>最新稼働率:</strong> ${stats.latest.toFixed(1)}%</div>
              </div>
            `;
          } else if (historyStats) {
            historyStats.textContent = "該当データなし";
          }
        }
        document.getElementById("updateHistoryBtn")?.addEventListener("click", updateHistoryChart);

        /***********************************************
         * fillHistoryStoreDropdown: 履歴グラフ用店舗ドロップダウン更新
         ***********************************************/
        async function fillHistoryStoreDropdown() {
          try {
            showSpinner();
            const response = await fetchWithRetry("/api/data", {}, 3, 2000);
            const stores = Array.isArray(response) ? response : (response.data || []);
            console.log("History store data:", stores);

            const storeSelect = document.getElementById("storeSelectHistory");
            if (!storeSelect) {
              hideSpinner();
              return;
            }

            const uniqueStores = [...new Set(stores.map(item => item.store_name))];
            console.log(`Found ${uniqueStores.length} unique stores`);
            storeSelect.innerHTML = '<option value="">全店舗</option>';

            const sortedStores = uniqueStores.sort();
            sortedStores.forEach(store => {
              storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
            });

            storeSelect.value = savedHistoryStore;
            storeSelect.addEventListener("change", () => { 
              localStorage.setItem("historyStoreFilter", storeSelect.value); 
            });

            // 初期表示用の日付設定
            const today = new Date();
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(today.getDate() - 7);
            
            // 日付フォーマット変換（YYYY-MM-DD）
            const formatDate = date => {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            };
            
            // 開始日と終了日を設定
            const startDateInput = document.getElementById("startDate");
            const endDateInput = document.getElementById("endDate");
            
            if (startDateInput && !startDateInput.value) {
              startDateInput.value = formatDate(oneWeekAgo);
            }
            
            if (endDateInput && !endDateInput.value) {
              endDateInput.value = formatDate(today);
            }

            hideSpinner();
          } catch (err) {
            console.error("履歴グラフ店舗リスト取得エラー:", err);
            console.error(err.stack);
            handleError(err, "fillHistoryStoreDropdown");
            hideSpinner();
          }
        }

        /***********************************************
         * updateHourlyAnalysis: 時間帯別分析更新 (/api/history)
         ***********************************************/
        async function updateHourlyAnalysis() {
          const loadingElement = document.getElementById('hourlyAnalysisLoading');
          const containerElement = document.getElementById('hourlyAnalysisContainer');
          const errorElement = document.getElementById('hourlyAnalysisError');
          const peakHoursInfo = document.getElementById('peakHoursInfo');
          const hourlyStats = document.getElementById("hourlyStats");

          // 初期化
          if (loadingElement) loadingElement.style.display = 'block';
          if (containerElement) containerElement.style.display = 'none';
          if (errorElement) errorElement.style.display = 'none';
          if (peakHoursInfo) peakHoursInfo.style.display = 'none';
          if (hourlyStats) hourlyStats.textContent = "データを読み込み中...";

          try {
            // 店舗選択状態の取得
            const hourlyStoreSelect = document.getElementById("hourlyStoreSelect");
            if(hourlyStoreSelect) {
              hourlyStoreSelect.value = savedHourlyStore;
              hourlyStoreSelect.addEventListener("change", () => { 
                localStorage.setItem("hourlyStoreFilter", hourlyStoreSelect.value); 
              });
            }
            
            const selectedStore = hourlyStoreSelect ? hourlyStoreSelect.value : "";
            const showPeakHours = document.getElementById('showPeakHours')?.checked || false;

            // データ取得パラメーター設定
            let apiUrl = "/api/history/optimized?limit=5000";
            if (selectedStore) {
              apiUrl += `&store=${encodeURIComponent(selectedStore)}`;
            }

            // データ取得
            const data = await fetchWithRetry(apiUrl, {}, 3, 2000);
            
            // データが空か確認
            if (!data || !Array.isArray(data) || 
                (data.items && data.items.length === 0) || 
                (Array.isArray(data) && data.length === 0)) {
              throw new Error(selectedStore ? 
                `選択された店舗「${selectedStore}」のデータがありません` : 
                "時間帯別分析のデータがありません");
            }

            // レスポンス形式対応
            const records = data.items ? data.items : data;
            
            // データフィルタリング
            let filtered = records;
            if (selectedStore) {
              filtered = records.filter(record => record.store_name === selectedStore);
              
              // 店舗データが存在するか確認
              if (filtered.length === 0) {
                throw new Error(`選択された店舗「${selectedStore}」のデータがありません`);
              }
            }

            // 時間帯ごとのデータを集計
            const hourlyData = processHourlyData(filtered);
            
            // ピーク時間帯の検出
            const peakInfo = detectPeakHours(hourlyData.avgRates);
            
            // ピーク時間帯の表示
            if (peakHoursInfo && peakInfo.peakHours.length > 0) {
              const peakHoursRange = document.getElementById('peakHoursRange');
              if (peakHoursRange) {
                const peakHoursText = formatPeakHours(peakInfo.peakHours);
                peakHoursRange.textContent = peakHoursText;
                peakHoursInfo.style.display = 'block';
              }
            }

            // チャートの作成
            createHourlyChart(hourlyData, selectedStore, showPeakHours, peakInfo);
            
            // 統計情報の表示
            if (hourlyStats) {
              const statsHtml = `
                <div class="d-flex flex-wrap justify-content-between">
                  <div><strong>総サンプル数:</strong> ${hourlyData.totalSamples}件</div>
                  <div><strong>平均稼働率:</strong> ${hourlyData.overallAvg.toFixed(1)}%</div>
                  <div><strong>最高稼働率:</strong> ${hourlyData.maxRate.toFixed(1)}% (${hourlyData.labels[hourlyData.maxRateHour]})</div>
                  <div><strong>最低稼働率:</strong> ${hourlyData.minRate.toFixed(1)}% (${hourlyData.labels[hourlyData.minRateHour]})</div>
                </div>
                <div class="mt-2 small">
                  <strong>稼働率が高い時間帯:</strong> ${peakInfo.peakHours.map(h => `${h}:00`).join(', ')}
                </div>
              `;
              hourlyStats.innerHTML = statsHtml;
            }

          } catch (err) {
            console.error("時間帯別分析エラー:", err);
            
            // エラー表示
            if (errorElement) {
              errorElement.textContent = `${err.message || "データ分析中にエラーが発生しました"}`;
              errorElement.style.display = 'block';
            }
            
            // 統計情報エリアにもエラーを表示
            if (hourlyStats) {
              hourlyStats.textContent = "データの取得または分析中にエラーが発生しました。";
            }
            
            // 空のチャートを表示
            if (document.getElementById("hourlyChart") && charts.hourly) {
              charts.hourly.destroy();
              const ctx = document.getElementById("hourlyChart").getContext("2d");
              charts.hourly = new Chart(ctx, {
                type: "line",
                data: {
                  labels: ["データなし"],
                  datasets: [{
                    label: "実働率 (%)",
                    data: [0],
                    borderColor: "rgba(200, 200, 200, 0.5)",
                    backgroundColor: "rgba(200, 200, 200, 0.1)"
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: {
                      display: true,
                      text: "データを取得できませんでした",
                      font: { size: 18, weight: 'bold' }
                    }
                  }
                }
              });
            }
          } finally {
            // ローディング表示の制御
            if (loadingElement) loadingElement.style.display = 'none';
            if (containerElement) containerElement.style.display = 'block';
          }
        }

        // 時間帯別データの処理
        function processHourlyData(records) {
          // 時間帯ごとの集計
          const hourly = {};
          records.forEach(record => {
            if (record.working_staff > 0) {
              const d = new Date(record.timestamp);
              const hour = d.getHours();
              const rate = record.rate ? parseFloat(record.rate) : 
                ((record.working_staff - record.active_staff) / record.working_staff * 100);

              if (!hourly[hour]) hourly[hour] = { sum: 0, count: 0, samples: [] };
              hourly[hour].sum += rate;
              hourly[hour].count += 1;
              hourly[hour].samples.push({
                timestamp: record.timestamp,
                rate: rate,
                working_staff: record.working_staff,
                active_staff: record.active_staff
              });
            }
          });

          // 時間帯ごとの平均を計算
          const labels = [];
          const avgRates = [];
          for (let h = 0; h < 24; h++) {
            labels.push(`${h}:00`);
            avgRates.push(hourly[h] && hourly[h].count > 0 ? 
              (hourly[h].sum / hourly[h].count) : 0);
          }

          // 統計情報の計算
          const numericRates = avgRates.map(r => parseFloat(r));
          const maxRate = Math.max(...numericRates);
          const maxRateHour = numericRates.indexOf(maxRate);
          const minRate = Math.min(...numericRates.filter(r => r > 0), maxRate);
          const minRateHour = numericRates.indexOf(minRate);
          const overallAvg = numericRates.reduce((sum, rate) => sum + rate, 0) / numericRates.length;
          const totalSamples = Object.values(hourly).reduce((sum, h) => sum + (h.count || 0), 0);

          return {
            hourly,
            labels,
            avgRates,
            numericRates,
            maxRate,
            maxRateHour,
            minRate,
            minRateHour,
            overallAvg,
            totalSamples
          };
        }

        // ピーク時間帯の検出
        function detectPeakHours(rateArray) {
          const numericRates = rateArray.map(r => parseFloat(r));
          const maxRate = Math.max(...numericRates);
          const peakHour = numericRates.indexOf(maxRate);
          const peakHours = [peakHour];
          
          // 閾値（最大値の85%以上を「ピーク」とする）
          const threshold = maxRate * 0.85;
          
          // 前後の時間帯をチェック
          let prevHour = (peakHour - 1 + 24) % 24;
          while (numericRates[prevHour] >= threshold) {
            peakHours.unshift(prevHour);
            prevHour = (prevHour - 1 + 24) % 24;
            if (peakHours.length >= 8) break; // 無限ループ防止
          }
          
          let nextHour = (peakHour + 1) % 24;
          while (numericRates[nextHour] >= threshold) {
            peakHours.push(nextHour);
            nextHour = (nextHour + 1) % 24;
            if (peakHours.length >= 8) break; // 無限ループ防止
          }
          
          return {
            peakHour,
            peakHours: peakHours.sort((a, b) => a - b),
            threshold
          };
        }

        // ピーク時間帯のフォーマット
        function formatPeakHours(peakHours) {
          if (peakHours.length === 0) return "--";
          
          // 連続する時間帯をグループ化
          const groups = [];
          let currentGroup = [peakHours[0]];
          
          for (let i = 1; i < peakHours.length; i++) {
            if (peakHours[i] === peakHours[i-1] + 1 || 
                (peakHours[i] === 0 && peakHours[i-1] === 23)) {
              // 連続している場合は同じグループに追加
              currentGroup.push(peakHours[i]);
            } else {
              // 連続していなければ新しいグループを作成
              groups.push(currentGroup);
              currentGroup = [peakHours[i]];
            }
          }
          groups.push(currentGroup);
          
          // グループを時間帯範囲に変換
          return groups.map(group => {
            if (group.length === 1) {
              return `${group[0]}:00`;
            } else {
              return `${group[0]}:00〜${group[group.length-1]}:00`;
            }
          }).join('、');
        }

        // 時間帯グラフの作成
        function createHourlyChart(data, selectedStore, showPeakHours, peakInfo) {
          const ctx = document.getElementById("hourlyChart").getContext("2d");
          if (charts.hourly) charts.hourly.destroy();
          
          // バックグラウンドカラーの設定
          const backgroundColors = data.avgRates.map((rate, index) => {
            const isNightTime = (index >= 22 || index <= 6);
            const isPeakHour = peakInfo.peakHours.includes(index) && showPeakHours;
            
            if (isPeakHour) {
              return 'rgba(255, 193, 7, 0.2)';
            } else if (isNightTime) {
              return 'rgba(33, 150, 243, 0.1)';
            } else {
              return 'rgba(76, 175, 80, 0.1)';
            }
          });

          // データセット定義
          const datasets = [
            {
              label: "平均実働率 (%)",
              data: data.avgRates,
              borderColor: "rgba(76, 175, 80, 1)",
              borderWidth: 2.5,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointBackgroundColor: data.avgRates.map((rate, index) => 
                peakInfo.peakHours.includes(index) && showPeakHours ? 
                  "rgba(255, 193, 7, 1)" : "rgba(76, 175, 80, 1)"),
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
              fill: true,
              segment: {
                borderColor: ctx => {
                  const index = ctx.p0DataIndex;
                  if (peakInfo.peakHours.includes(index) && showPeakHours) {
                    return "rgba(255, 193, 7, 0.8)";
                  } else if (index >= 22 || index <= 6) {
                    return "rgba(33, 150, 243, 0.8)";
                  }
                  return "rgba(76, 175, 80, 1)";
                }
              },
              backgroundColor: backgroundColors
            },
            {
              label: "全体平均",
              data: Array(24).fill(data.overallAvg),
              borderColor: "rgba(150, 150, 150, 0.7)",
              borderWidth: 1,
              borderDash: [5, 5],
              fill: false,
              pointRadius: 0,
              pointHoverRadius: 0,
              tension: 0
            }
          ];

          // チャート作成
          charts.hourly = new Chart(ctx, {
            type: "line",
            data: {
              labels: data.labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                title: { 
                  display: true, 
                  text: selectedStore ? 
                    `「${selectedStore}」の時間帯別分析` : 
                    "全店舗の時間帯別分析", 
                  font: { 
                    size: 20,
                    weight: 'bold'
                  } 
                },
                tooltip: { 
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleFont: { weight: 'bold' },
                  bodyFont: { size: 14 },
                  padding: 10,
                  callbacks: { 
                    label: context => {
                      if (context.dataset.label === "全体平均") {
                        return `全体平均: ${context.parsed.y.toFixed(1)}%`;
                      }
                      return `稼働率: ${context.parsed.y.toFixed(1)}%`;
                    },
                    title: (items) => {
                      const hour = parseInt(items[0].label);
                      // 時間帯の特徴を追加
                      let timeDesc = "";
                      if (hour >= 22 || hour <= 5) {
                        timeDesc = "（深夜時間帯）";
                      } else if (hour >= 17 && hour <= 21) {
                        timeDesc = "（夕方〜夜）";
                      } else if (hour >= 12 && hour <= 16) {
                        timeDesc = "（昼〜午後）";
                      } else if (hour >= 6 && hour <= 11) {
                        timeDesc = "（朝〜昼）";
                      }
                      return `${items[0].label} ${timeDesc}`;
                    },
                    afterBody: (items) => {
                      const hour = parseInt(items[0].label);
                      const hourlyItem = data.hourly[hour];
                      if (hourlyItem && hourlyItem.count > 0) {
                        return [`サンプル数: ${hourlyItem.count}件`];
                      }
                      return [];
                    }
                  } 
                },
                crosshair: {
                  line: {
                    color: 'rgba(100, 100, 100, 0.4)',
                    width: 1,
                    dashPattern: [5, 5]
                  },
                  sync: {
                    enabled: true
                  }
                }
              },
              scales: {
                y: { 
                  beginAtZero: true, 
                  max: Math.min(Math.ceil(data.maxRate * 1.1), 100), 
                  title: { 
                    display: true, 
                    text: "実働率 (%)",
                    font: { 
                      weight: 'bold',
                      size: 14
                    }
                  },
                  grid: {
                    color: 'rgba(200, 200, 200, 0.3)',
                    lineWidth: 1
                  },
                  ticks: {
                    font: { size: 12 },
                    callback: function(value) {
                      if ([0, 25, 50, 75, 100].includes(value)) {
                        return value + '%';
                      }
                      return value;
                    }
                  }
                },
                x: { 
                  title: { 
                    display: true, 
                    text: "時間帯",
                    font: { 
                      weight: 'bold',
                      size: 14
                    }
                  },
                  grid: {
                    color: 'rgba(200, 200, 200, 0.3)',
                    lineWidth: 1,
                    z: -1
                  },
                  ticks: {
                    font: { size: 12 },
                    callback: function(value) {
                      const hour = parseInt(value);
                      if (hour === 0) return "0:00 (深夜)";
                      if (hour === 6) return "6:00 (朝)";
                      if (hour === 12) return "12:00 (昼)";
                      if (hour === 18) return "18:00 (夜)";
                      return `${hour}:00`;
                    }
                  }
                }
              },
              animation: { duration: 800 },
              elements: {
                line: {
                  tension: 0.4
                }
              }
            }
          });

          // ピークハイライトのイベントハンドラ設定
          document.getElementById('showPeakHours')?.addEventListener('change', updateHourlyAnalysis);
        }
        document.getElementById("updateHourlyBtn")?.addEventListener("click", updateHourlyAnalysis);

        /***********************************************
         * fillHourlyStoreDropdown: 時間帯分析用店舗ドロップダウン更新
         ***********************************************/
        async function fillHourlyStoreDropdown() {
          try {
            showSpinner();
            const response = await fetchWithRetry("/api/data", {}, 3, 2000);
            const stores = Array.isArray(response) ? response : (response.data || []);
            console.log("Hourly store data:", stores);

            const hourlyStoreSelect = document.getElementById("hourlyStoreSelect");
            if (!hourlyStoreSelect) {
              hideSpinner();
              return;
            }

            const uniqueStores = [...new Set(stores.map(item => item.store_name))];
            console.log(`Found ${uniqueStores.length} unique stores for hourly dropdown`);
            hourlyStoreSelect.innerHTML = '<option value="">全店舗</option>';

            const sortedStores = uniqueStores.sort();
            sortedStores.forEach(store => { 
              hourlyStoreSelect.innerHTML += `<option value="${store}">${store}</option>`; 
            });

            hourlyStoreSelect.value = savedHourlyStore;
            hideSpinner();
          } catch (err) {
            console.error("時間帯分析店舗リスト取得エラー:", err);
            console.error(err.stack);
            handleError(err, "fillHourlyStoreDropdown");
            hideSpinner();
          }
        }

        /***********************************************
         * updateAreaStatistics: エリア統計更新
         * ・店舗数は /api/data から取得
         * ・平均稼働率は /api/history から計算
         ***********************************************/
        async function updateAreaStatistics() {
          try {
            showSpinner();

            // エリア統計データを取得
            const areaData = await fetchWithRetry("/api/area-stats", {}, 3, 2000);
            console.log("Area stats data:", areaData);

            // テーブル表示用に、両方のデータを統合
            const areaTable = document.getElementById("areaTable");
            if (!areaTable) {
              console.error("areaTable element not found");
              hideSpinner();
              return;
            }

            areaTable.innerHTML = "";
            const labels = [];
            const avgRates = [];
            areaData.forEach(item => {
              areaTable.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${item.area}</td>
                  <td>${item.store_count}</td>
                  <td>${item.avg_rate.toFixed(1)}</td>
                </tr>
              `);

              labels.push(item.area);
              avgRates.push(item.avg_rate);
            });

            const ctx = document.getElementById("areaChart").getContext("2d");
            if (!ctx) {
              console.error("areaChart canvas context not found");
              hideSpinner();
              return;
            }

            if (charts.area) charts.area.destroy();

            charts.area = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [{
                  label: "平均稼働率 (%)",
                  data: avgRates,
                  backgroundColor: "rgba(153, 102, 255, 0.7)",
                  borderColor: "rgba(153, 102, 255, 1)",
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: { display: true, text: "エリア別平均稼働率", font: { size: 18 } }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "平均稼働率 (%)" } }
                }
              }
            });

            hideSpinner();
          } catch (error) {
            console.error("エリア統計エラー:", error);
            console.error(error.stack);
            handleError(error, "updateAreaStatistics");
            hideSpinner();
          }
        }

        /***********************************************
         * fillIndustryDropdown: 業種内ジャンルランキング用ドロップダウン更新
         ***********************************************/
        async function fillIndustryDropdown() {
          try {
            // 最新データ取得
            const latestData = await fetchWithRetry("/api/data", {}, 3, 2000);
            const data = Array.isArray(latestData) ? latestData : (latestData.data || []);
            const industries = new Set();
            data.forEach(item => { if(item.biz_type && item.biz_type !== "不明") industries.add(item.biz_type); });
            const industrySelect = document.getElementById("industrySelectType");
            if (!industrySelect) return;
            industrySelect.innerHTML = "";
            industries.forEach(ind => { industrySelect.innerHTML += `<option value="${ind}">${ind}</option>`; });
            industrySelect.value = savedIndustry;
            industrySelect.addEventListener("change", () => {
              localStorage.setItem("industryFilter", industrySelect.value);
              updateIndustryRanking();
            });
          } catch (err) {
            console.error("業種ドロップダウン取得エラー:", err);
            handleError(err, "fillIndustryDropdown");
          }
        }

        async function updateIndustryRanking(industry = null) {
          try {
            showSpinner();

            if (!industry) {
              // 修正: ID名の不一致を修正
              const industrySelector = document.getElementById("industrySelectType");
              industry = industrySelector ? industrySelector.value : null;
            }

            // API呼び出し
            const latestData = await fetchWithRetry("/api/data", {}, 3, 2000);
            const data = Array.isArray(latestData) ? latestData : (latestData.data || []);
            const latestStoreNames = new Set(data.map(store => store.store_name));
            const dataHistory = await fetchWithRetry("/api/history", {}, 3, 2000);
            const filtered = dataHistory.filter(record => latestStoreNames.has(record.store_name) &&
              (industry ? record.biz_type === industry : true));
            const genreData = {};
            filtered.forEach(record => {
              const genre = record.genre || "不明";
              if (!genreData[genre]) { genreData[genre] = { stores: new Set(), totalRate: 0, rateCount: 0 }; }
              genreData[genre].stores.add(record.store_name);
              if (record.working_staff > 0) {
                genreData[genre].totalRate += ((record.working_staff - record.active_staff) / record.working_staff * 100);
                genreData[genre].rateCount += 1;
              }
            });
            const typeTableBody = document.getElementById("typeTableBody");
            typeTableBody.innerHTML = "";
            const labels = [];
            const avgRates = [];
            let rank = 1;

            // ジャンルを平均稼働率で降順ソート
            const sortedGenres = Object.entries(genreData)
              .map(([genre, data]) => {
                const avgRate = data.rateCount > 0 ? data.totalRate / data.rateCount : 0;
                return { genre, storeCount: data.stores.size, avgRate };
              })
              .sort((a, b) => b.avgRate - a.avgRate);

            sortedGenres.forEach(item => {
              typeTableBody.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${rank++}</td>
                  <td>${item.genre}</td>
                  <td>${item.storeCount}</td>
                  <td>${item.avgRate.toFixed(1)}</td>
                </tr>
              `);
              labels.push(item.genre);
              avgRates.push(item.avgRate.toFixed(1));
            });

            const ctx = document.getElementById("typeChart").getContext("2d");
            if (charts.type) charts.type.destroy();
            charts.type = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [{
                  label: "平均稼働率 (%)",
                  data: avgRates,
                  backgroundColor: "rgba(255, 206, 86, 0.7)",
                  borderColor: "rgba(255, 206, 86, 1)",
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "平均稼働率 (%)" } }
                }
              }
            });
            hideSpinner();
          } catch (error) {
            console.error("業種内ジャンルランキングエラー:", error);
            handleError(error, "updateIndustryRanking");
            hideSpinner();
          }
        }

        /***********************************************
         * updateDetailHistoryChart: 店舗詳細モーダル内履歴グラフ更新 (/api/history)
         ***********************************************/
        async function updateDetailHistoryChart(storeName) {
          try {
            const data = await fetchWithRetry("/api/history", {}, 3, 2000);
            const filtered = data.filter(record => record.store_name === storeName)
                                 .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const labels = filtered.map(record => {
              const d = new Date(record.timestamp);
              return d.toLocaleDateString() + " " + d.toTimeString().substring(0, 5);
            });
            const effectiveRates = filtered.map(record => record.working_staff > 0 ? ((record.working_staff - record.active_staff) / record.working_staff * 100).toFixed(1) : 0);
            const ctx = document.getElementById("detailHistoryChart").getContext("2d");
            if (charts.detailHistory) charts.detailHistory.destroy();
            charts.detailHistory = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [{
                  label: "実働率 (%)",
                  data: effectiveRates,
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  fill: false,
                  tension: 0.3,
                  pointRadius: 3,
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: { display: true, text: "店舗履歴グラフ", font: { size: 20 } },
                  tooltip: { callbacks: { label: context => `${context.parsed.y}%` } },
                  zoom: {
                    pan: { enabled: true, mode: 'xy' },
                    zoom: {
                      wheel: { enabled: true },
                      pinch: { enabled: true },
                      mode: 'xy'
                    }
                  }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "実働率 (%)" } },
                  x: { title: { display: true, text: "日時" } }
                },
                animation: { duration: 1000 }
              }
            });
          } catch (error) {
            console.error("店舗詳細履歴グラフエラー:", error);
            handleError(error, "updateDetailHistoryChart");
          }
        }

        /***********************************************
         * updateDetailHourlyChart: 店舗詳細モーダル内時間帯分析更新 (/api/history)
         ***********************************************/
        async function updateDetailHourlyChart(storeName) {
          try {
            const data = await fetchWithRetry(`/api/history?store=${encodeURIComponent(storeName)}&limit=1000`, {}, 3, 2000);
            
            // データが存在するか確認
            if (!data || !Array.isArray(data) || data.length === 0) {
              throw new Error(`店舗「${storeName}」の時間帯データが見つかりません`);
            }
            
            // 時間帯ごとのデータを集計
            const hourly = {};
            data.forEach(record => {
              if (record.working_staff > 0) {
                const d = new Date(record.timestamp);
                const hour = d.getHours();
                const rate = record.rate ? parseFloat(record.rate) : 
                  ((record.working_staff - record.active_staff) / record.working_staff * 100);
                
                if (!hourly[hour]) hourly[hour] = { sum: 0, count: 0 };
                hourly[hour].sum += rate;
                hourly[hour].count += 1;
              }
            });
            
            // 時間帯ごとの平均稼働率を計算
            const labels = [];
            const avgRates = [];
            for (let h = 0; h < 24; h++) {
              labels.push(`${h}:00`);
              avgRates.push(hourly[h] && hourly[h].count > 0 ? (hourly[h].sum / hourly[h].count) : 0);
            }
            
            // バックグラウンドカラーの設定
            const backgroundColors = avgRates.map((rate, index) => {
              // 深夜時間帯（22時～6時）は薄い青、それ以外は薄い緑
              return (index >= 22 || index <= 6) ? 
                'rgba(33, 150, 243, 0.1)' : 
                'rgba(54, 162, 235, 0.1)';
            });
            
            const ctx = document.getElementById("detailHourlyChart").getContext("2d");
            if (charts.detailHourly) charts.detailHourly.destroy();
            
            charts.detailHourly = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [{
                  label: "平均実働率 (%)",
                  data: avgRates,
                  borderColor: "rgba(54, 162, 235, 1)",
                  backgroundColor: backgroundColors,
                  fill: true,
                  tension: 0.3,
                  pointRadius: 5,
                  pointHoverRadius: 7,
                  pointBackgroundColor: "rgba(54, 162, 235, 1)",
                  pointBorderColor: "#fff",
                  pointBorderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: { 
                    display: true, 
                    text: `「${storeName}」時間帯別分析`, 
                    font: { size: 18, weight: 'bold' } 
                  },
                  tooltip: { 
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { weight: 'bold' },
                    bodyFont: { size: 14 },
                    padding: 10,
                    callbacks: { 
                      label: context => `稼働率: ${context.parsed.y.toFixed(1)}%`,
                      afterBody: (items) => {
                        const hour = parseInt(items[0].label);
                        if (hourly[hour]) {
                          return [`サンプル数: ${hourly[hour].count}件`];
                        }
                        return [];
                      }
                    } 
                  },
                  zoom: {
                    pan: { enabled: true, mode: 'xy' },
                    zoom: {
                      wheel: { enabled: true },
                      pinch: { enabled: true },
                      mode: 'xy'
                    }
                  }
                },
                scales: {
                  y: { 
                    beginAtZero: true, 
                    max: 100, 
                    title: { 
                      display: true, 
                      text: "実働率 (%)",
                      font: { weight: 'bold' }
                    } 
                  },
                  x: { 
                    title: { 
                      display: true, 
                      text: "時間帯",
                      font: { weight: 'bold' }
                    },
                    ticks: {
                      callback: function(value) {
                        const hour = parseInt(value);
                        if (hour === 0) return "0:00 (深夜)";
                        if (hour === 6) return "6:00 (朝)";
                        if (hour === 12) return "12:00 (昼)";
                        if (hour === 18) return "18:00 (夜)";
                        return `${hour}:00`;
                      }
                    }
                  }
                },
                animation: { duration: 800 }
              }
            });
          } catch (err) {
            console.error("店舗詳細時間帯分析エラー:", err);
            handleError(err, "updateDetailHourlyChart");
            
            // エラー時に空のチャートを表示
            const ctx = document.getElementById("detailHourlyChart");
            if (ctx && ctx.getContext) {
              if (charts.detailHourly) charts.detailHourly.destroy();
              charts.detailHourly = new Chart(ctx.getContext("2d"), {
                type: "line",
                data: {
                  labels: ["データなし"],
                  datasets: [{
                    label: "実働率 (%)",
                    data: [0],
                    borderColor: "rgba(200, 200, 200, 0.5)",
                    backgroundColor: "rgba(200, 200, 200, 0.1)"
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: {
                      display: true,
                      text: `「${storeName}」のデータがありません`,
                      font: { size: 16 }
                    }
                  }
                }
              });
            }
          }
        }

        /***********************************************
         * updateAverageRanking: 平均稼働ランキング更新 (/api/ranking/average)
         ***********************************************/
        async function updateAverageRanking() {
          const loadingEl = document.getElementById('averageRankingLoading');
          const containerEl = document.getElementById('averageRankingContainer');

          if (loadingEl) loadingEl.style.display = 'block';
          if (containerEl) containerEl.style.display = 'none';

          try {
            // ランキングタイプと業種フィルターを取得
            const rankingType = document.getElementById('rankingTypeSelect').value;
            const industryFilter = document.getElementById('industrySelectRanking');
            let url = '/api/ranking/average?limit=1000'; // 最大1000件表示

            // 業種別フィルターが選択されている場合
            if (rankingType === 'industry' && industryFilter && industryFilter.value) {
              url += `&biz_type=${encodeURIComponent(industryFilter.value)}`;
            }

            // API呼び出し
            const data = await fetchWithRetry(url, {}, 3, 2000);
            const tbody = document.getElementById("rankingTableBody");
            tbody.innerHTML = "";

            data.forEach((store, index) => {
              const rowHtml = `
                <tr>
                  <td>${index + 1}</td>
                  <td>${store.store_name}</td>
                  <td>${store.biz_type || '-'}</td>
                  <td>${store.genre || '-'}</td>
                  <td>${store.area || '-'}</td>
                  <td>${store.avg_rate.toFixed(1)}</td>
                </tr>
              `;
              tbody.insertAdjacentHTML("beforeend", rowHtml);
            });
          } catch (error) {
            console.error('平均稼働ランキングエラー:', error);

            // APIが404の場合はローカルデータから平均を計算
            if (error.toString().includes('HTTP error 404')) {
              try {
                // 最新データからランキングを計算
                const data = await fetchWithRetry('/api/data', {}, 3, 2000);                const storeData = Array.isArray(data) ? data : (data.data || []);

                // 平均稼働率計算のためのモックデータ
                const mockRankingData = storeData.map(store => {
                  const rate = store.working_staff > 0 
                    ? ((store.working_staff - store.active_staff) / store.working_staff * 100) 
                    : 0;

                  return {
                    store_name: store.store_name,
                    biz_type: store.biz_type || '-',
                    genre: store.genre || '-',
                    area: store.area || '-',
                    avg_rate: rate
                  };
                }).sort((a, b) => b.avg_rate - a.avg_rate);

                // ランキングタイプに応じた表示
                const rankingType = document.getElementById('rankingTypeSelect').value;
                const industryFilter = document.getElementById('industrySelectRanking');

                let filteredData = mockRankingData;
                if (rankingType === 'industry' && industryFilter && industryFilter.value) {
                  filteredData = mockRankingData.filter(store => 
                    store.biz_type === industryFilter.value
                  );
                }

                const tbody = document.getElementById("rankingTableBody");
                tbody.innerHTML = "";

                filteredData.forEach((store, index) => {
                  const rowHtml = `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${store.store_name}</td>
                      <td>${store.biz_type}</td>
                      <td>${store.genre}</td>
                      <td>${store.area}</td>
                      <td>${store.avg_rate.toFixed(1)}</td>
                    </tr>
                  `;
                  tbody.insertAdjacentHTML("beforeend", rowHtml);
                });
              } catch (fallbackError) {
                console.error('フォールバック処理エラー:', fallbackError);
                document.getElementById("rankingTableBody").innerHTML = 
                  '<tr><td colspan="6" class="text-center">データ取得エラー</td></tr>';
              }
            } else {
              document.getElementById("rankingTableBody").innerHTML = 
                '<tr><td colspan="6" class="text-center">データ取得エラー</td></tr>';
            }
          } finally {
            if (loadingEl) loadingEl.style.display = 'none';
            if (containerEl) containerEl.style.display = 'block';
          }
        }

        /***********************************************
         * fillIndustryDropdownForRanking: 業種別ランキング用ドロップダウン更新
         ***********************************************/
        async function fillIndustryDropdownForRanking() {
          try {
            // 最適化: 現在のデータから業種を取得（履歴全件不要）
            const response = await fetchWithRetry("/api/data", {}, 3, 2000);
            const data = Array.isArray(response) ? response : (response.data || []);
            const industries = new Set();

            data.forEach(record => { 
              if (record.biz_type) industries.add(record.biz_type); 
            });

            const industrySelect = document.getElementById("industrySelectRanking");
            if (!industrySelect) {
              console.error("industrySelectRanking element not found");
              return;
            }

            industrySelect.innerHTML = "";

            // 業種でソート
            const sortedIndustries = Array.from(industries).sort();
            sortedIndustries.forEach(ind => { 
              industrySelect.innerHTML += `<option value="${ind}">${ind}</option>`; 
            });

            // ローカルストレージから前回の選択を復元
            const savedIndustryRanking = localStorage.getItem("industryRankingFilter");
            if (savedIndustryRanking && sortedIndustries.includes(savedIndustryRanking)) {
              industrySelect.value = savedIndustryRanking;
            }

            // 選択変更時の保存処理
            industrySelect.addEventListener("change", () => {
              localStorage.setItem("industryRankingFilter", industrySelect.value);
            });
          } catch (err) {
            console.error("ランキング業種ドロップダウン取得エラー:", err);
            handleError(err, "fillIndustryDropdownForRanking");
          }
        }

        // ランキングタイプ変更イベント
        document.getElementById("rankingTypeSelect")?.addEventListener("change", async function() {
          if (this.value === "industry") {
            document.getElementById("industryFilterDiv").style.display = "block";
            await fillIndustryDropdownForRanking();
          } else {
            document.getElementById("industryFilterDiv").style.display = "none";
          }
        });
        document.getElementById("updateRankingBtn")?.addEventListener("click", updateAverageRanking);

        // 比較分析ボタンクリック時の処理
        document.getElementById('compareBtn')?.addEventListener("click", function() {
          const checkedStores = Array.from(document.querySelectorAll('.compare-checkbox:checked')).map(checkbox => checkbox.dataset.storeName);
          if (checkedStores.length < 2) {
            alert('比較分析には2店舗以上を選択してください。');
            return;
          }

          // 比較分析モーダル表示とグラフ描画処理
          const modal = new bootstrap.Modal(document.getElementById('compareModal'));
          modal.show();

          // 比較チャート描画
          fetchWithRetry("/api/history", {}, 3, 2000)
            .then(data => {
              const datasets = [];
              const storeData = {};

              // 各店舗のデータを集計
              checkedStores.forEach(storeName => {
                const storeRecords = data.filter(record => record.store_name === storeName);
                if (storeRecords.length === 0) return;

                // データを日付でグループ化
                const dateData = {};
                storeRecords.forEach(record => {
                  const date = new Date(record.timestamp).toLocaleDateString();
                  if (!dateData[date]) {
                    dateData[date] = { sum: 0, count: 0 };
                  }
                  if (record.working_staff > 0) {
                    const rate = ((record.working_staff - record.active_staff) / record.working_staff * 100);
                    dateData[date].sum += rate;
                    dateData[date].count += 1;
                  }
                });

                // 日付ごとの平均を計算
                storeData[storeName] = { dates: [], rates: [] };
                Object.entries(dateData)
                  .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                  .forEach(([date, data]) => {
                    storeData[storeName].dates.push(date);
                    storeData[storeName].rates.push(
                      data.count > 0 ? data.sum / data.count : 0
                    );
                  });

                // データセット作成
                const colors = [
                  'rgba(255, 99, 132, 0.7)',
                  'rgba(54, 162, 235, 0.7)',
                  'rgba(255, 206, 86, 0.7)',
                  'rgba(75, 192, 192, 0.7)',
                  'rgba(153, 102, 255, 0.7)'
                ];

                datasets.push({
                  label: storeName,
                  data: storeData[storeName].rates,
                  borderColor: colors[datasets.length % colors.length],
                  backgroundColor: colors[datasets.length % colors.length].replace('0.7', '0.1'),
                  fill: false,
                  tension: 0.3
                });
              });

              // 共通の日付ラベルを作成
              const allDates = new Set();
              Object.values(storeData).forEach(data => {
                data.dates.forEach(date => allDates.add(date));
              });
              const sortedDates = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));

              // チャート描画
              const ctx = document.getElementById('compareChart').getContext('2d');
              if (charts.compare) charts.compare.destroy();

              charts.compare = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: sortedDates,
                  datasets: datasets.map((dataset, index) => {
                    // データセットごとに線の太さ・スタイルを少しずつ変える
                    return {
                      ...dataset,
                      borderWidth: 2 + (index * 0.5 > 2 ? 2 : index * 0.5),
                      pointRadius: 3,
                      pointHoverRadius: 6,
                      pointBackgroundColor: dataset.borderColor,
                      pointBorderColor: '#fff',
                      pointBorderWidth: 1.5,
                      tension: 0.3,
                      fill: false
                    };
                  })
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                    mode: 'index',
                    intersect: false,
                  },
                  plugins: {
                    title: {
                      display: true,
                      text: '店舗比較分析 - 日別平均稼働率',
                      font: { size: 20, weight: 'bold' }
                    },
                    tooltip: {
                      backgroundColor: 'rgba(0, 0, 0, 0.8)',
                      titleFont: { weight: 'bold' },
                      bodyFont: { size: 14 },
                      padding: 10,
                      callbacks: {
                        label: context => `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`
                      }
                    },
                    // ズーム機能を無効化
                    crosshair: {
                      line: {
                        color: 'rgba(100, 100, 100, 0.4)',
                        width: 1,
                        dashPattern: [5, 5]
                      },
                      sync: {
                        enabled: true
                      },
                      zoom: {
                        enabled: true
                      }
                    },
                    legend: {
                      position: 'top',
                      labels: {
                        boxWidth: 15,
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                      }
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 100,
                      title: { 
                        display: true, 
                        text: '稼働率 (%)',
                        font: { 
                          weight: 'bold',
                          size: 14
                        }
                      },
                      grid: {
                        color: 'rgba(200, 200, 200, 0.3)',
                        lineWidth: 1,
                        drawBorder: true,
                        drawTicks: true
                      },
                      ticks: {
                        font: { size: 12 },
                        padding: 5
                      }
                    },
                    x: {
                      title: { 
                        display: true, 
                        text: '日付',
                        font: { 
                          weight: 'bold',
                          size: 14
                        }
                      },
                      grid: {
                        color: 'rgba(200, 200, 200, 0.3)',
                        lineWidth: 1,
                        drawBorder: true,
                        drawTicks: true
                      },
                      ticks: {
                        maxTicksLimit: Math.min(sortedDates.length, 12),
                        font: { size: 11 },
                        padding: 5,
                        maxRotation: 45,
                        minRotation: 45
                      }
                    }
                  },
                  animation: { duration: 800 },
                  elements: {
                    line: {
                      tension: 0.3
                    }
                  }
                }
              });

              // ズーム機能を無効化したため、リセットボタンは不要
            })
            .catch(error => {
              console.error('比較分析データ取得エラー:', error);
              handleError(error, "compareChartData");
            });
        });

        /***********************************************
         * 初期ロード処理
         ***********************************************/
        function init() {
          updateDashboard();
          updateTop10Chart();
          updateAreaStatistics();
          fillIndustryDropdown();
          updateIndustryRanking();
          fillHistoryStoreDropdown();
          updateHistoryChart();
          fillHourlyStoreDropdown();
          updateHourlyAnalysis();
          updateAverageRanking();
        }

        /***********************************************
         * グローバルエラーハンドリング
         ***********************************************/
        function handleError(error, context) {
          console.error(`エラー (${context}):`, error);
          // エラー表示用の要素があれば利用する
          const errorContainer = document.getElementById('errorContainer');
          if (errorContainer) {
            errorContainer.textContent = `エラーが発生しました (${context}): ${error.message || error}`;
            errorContainer.style.display = 'block';
            // 5秒後に非表示
            setTimeout(() => {
              errorContainer.style.display = 'none';
            }, 5000);
          }
        }

        window.addEventListener('error', function(event) {
          handleError(event.error, 'global');
        });

        // タブ切り替え処理
        document.querySelectorAll('.nav-link').forEach(button => {
          button.addEventListener('click', function() {
            // すべてのタブボタンから active クラスを削除
            document.querySelectorAll('.nav-link').forEach(btn => {
              btn.classList.remove('active');
            });

            // クリックされたボタンに active クラスを追加
            this.classList.add('active');

            // すべてのタブコンテンツを非表示
            document.querySelectorAll('.tab-pane').forEach(content => {
              content.classList.remove('show', 'active');
            });

            // クリックされたボタンのターゲットコンテンツを表示
            const targetId = this.getAttribute('href');
            document.querySelector(targetId).classList.add('show', 'active');
          });
        });

        // 初期処理実行
        init();
      });
    })();
  </script>
</body>
</html>
