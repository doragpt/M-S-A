<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>統合ダッシュボード</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    /* 共通スタイル */
    body {
      background-color: #f7f7f7;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .header {
      background-color: #007bff;
      color: #fff;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .header.dark {
      background-color: #444;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-header {
      font-weight: bold;
      background-color: rgba(0,123,255,0.85);
    }
    .card-body {
      font-size: 1.2rem;
    }
    .tab-pane {
      margin-top: 20px;
    }
    .chart-container {
      position: relative;
      margin: auto;
      height: 400px;
    }
    table.dataTable tbody tr {
      background-color: transparent;
    }
    .store-name.clickable {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .badge {
      font-size: 0.9rem;
    }
    /* ダークモード */
    body.dark {
      background-color: #333;
      color: #eee;
    }
    body.dark .header {
      background-color: #444;
    }
    body.dark .card {
      background-color: #555;
      color: #fff;
    }
    body.dark table.dataTable tbody tr {
      color: #fff;
    }
    .modal-header {
      background-color: #007bff;
      color: #fff;
      border-bottom: none;
    }
    /* Toast 用スタイル */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }
    /* ローディングスピナー */
    #loadingSpinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      display: none;
    }
  </style>
</head>
<body>
  <!-- ローディングスピナー -->
  <div id="loadingSpinner">
    <div class="d-flex flex-column align-items-center bg-white p-4 rounded shadow">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mb-0" id="loadingMessage">データを読み込み中です...</p>
      <div class="progress mt-2 w-100" style="display: none;" id="loadingProgress">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- ヘッダー -->
  <div class="header" id="pageHeader">
    <h1>統合ダッシュボード</h1>
    <div class="btn-group">
      <button id="darkModeToggle" class="btn btn-light btn-sm">ダークモード切替</button>
      <button id="favoritesToggle" class="btn btn-light btn-sm">お気に入りのみ表示</button>
    </div>
  </div>

  <div class="container-fluid my-3">
    <!-- メインタブ -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab">店舗稼働状況</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history" role="tab">店舗履歴グラフ（期間指定）</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="hourly-tab" data-bs-toggle="tab" href="#hourly" role="tab">時間帯別分析</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="area-tab" data-bs-toggle="tab" href="#area" role="tab">エリア統計</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="type-tab" data-bs-toggle="tab" href="#type" role="tab">業種内ジャンルランキング</a>
      </li>
      <!-- 新規追加：平均稼働ランキングタブ -->
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="ranking-tab" data-bs-toggle="tab" href="#ranking" role="tab">平均稼働ランキング</a>
      </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="dashboardTabsContent">
      <!-- タブ1: 店舗稼働状況 -->
      <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
        <div class="row my-4">
          <!-- 各カード：店舗数、平均稼働率、最高稼働率 -->
          <div class="col-md-4 mb-3">
            <div class="card text-white bg-primary">
              <div class="card-header">店舗数</div>
              <div class="card-body">
                <h5 id="totalStores" class="card-title">--</h5>
                <p class="card-text">現在データがある店舗数</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card text-white bg-success">
              <div class="card-header">平均稼働率</div>
              <div class="card-body">
                <h5 id="avgRate" class="card-title">--</h5>
                <p class="card-text">勤務中キャストに対する実働率</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card text-white bg-warning">
              <div class="card-header">最高稼働率</div>
              <div class="card-body">
                <h5 id="maxRate" class="card-title">--</h5>
                <p class="card-text">最高の稼働率店舗の稼働率</p>
              </div>
            </div>
          </div>
        </div>
        <!-- 店舗情報テーブル -->
        <div class="row">
          <div class="col">
            <div class="table-responsive">
              <table id="storeTable" class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>選択</th>
                    <th>店舗名</th>
                    <th>業種</th>
                    <th>ジャンル</th>
                    <th>エリア</th>
                    <th>総出勤</th>
                    <th>勤務中人数</th>
                    <th>即ヒメ人数</th>
                    <th>現在稼働率 (%)</th>
                    <th>状態</th>
                    <th>直近1週間の稼働率 (%)</th>
                    <th>直近1か月の稼働率 (%)</th>
                  </tr>
                </thead>
                <tbody id="dataTable"></tbody>
              </table>
            </div>
            <!-- CSVエクスポート・比較分析ボタン -->
            <button id="exportCSV" class="btn btn-secondary mt-2">CSVエクスポート</button>
            <button id="compareBtn" class="btn btn-info mt-2">比較分析</button>
          </div>
        </div>
        <!-- トップ10店舗グラフ -->
        <div class="row my-3">
          <div class="col">
            <canvas id="currentRateChart"></canvas>
          </div>
        </div>
      </div>

      <!-- タブ2: 店舗履歴グラフ（期間指定） -->
      <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <div class="my-4">
          <h3>店舗履歴グラフ（期間指定）</h3>
          <div class="row mb-3">
            <div class="col-md-3">
              <label for="storeSelectHistory" class="form-label">店舗選択</label>
              <select id="storeSelectHistory" class="form-select">
                <option value="">全店舗</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="startDate" class="form-label">開始日</label>
              <input type="date" id="startDate" class="form-control" />
            </div>
            <div class="col-md-3">
              <label for="endDate" class="form-label">終了日</label>
              <input type="date" id="endDate" class="form-control" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button id="updateHistoryBtn" class="btn btn-primary w-100">更新</button>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body">
              <canvas id="historyChart"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">集計結果</h5>
              <p id="historyStats" class="mb-0">--</p>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ3: 時間帯別分析 -->
      <div class="tab-pane fade" id="hourly" role="tabpanel" aria-labelledby="hourly-tab">
        <div class="my-4">
          <h3>時間帯別分析</h3>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="hourlyStoreSelect" class="form-label">店舗選択</label>
              <select id="hourlyStoreSelect" class="form-select">
                <option value="">全店舗</option>
              </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button id="updateHourlyBtn" class="btn btn-primary w-100">更新</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">集計結果</h5>
              <p id="hourlyStats" class="mb-0">--</p>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ4: エリア統計 -->
      <div class="tab-pane fade" id="area" role="tabpanel" aria-labelledby="area-tab">
        <div class="my-4">
          <h2 class="mb-4 text-center">エリア統計</h2>
          <div class="table-responsive mb-3">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>エリア</th>
                  <th>店舗数</th>
                  <th>平均稼働率 (%)</th>
                </tr>
              </thead>
              <tbody id="areaTable"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="card-body">
              <canvas id="areaChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ5: 業種内ジャンルランキング -->
      <div class="tab-pane fade" id="type" role="tabpanel" aria-labelledby="type-tab">
        <div class="my-4">
          <h2 class="mb-4 text-center">業種内ジャンルランキング</h2>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="industrySelectType" class="form-label">業種を選択</label>
              <select id="industrySelectType" class="form-select"></select>
            </div>
            <div class="col-md-6">
              <div class="spinner-border text-primary" role="status" style="display:none;">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="table-responsive mb-3">
            <table id="typeTable" class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>順位</th>
                  <th>ジャンル</th>
                  <th>店舗数</th>
                  <th>平均稼働率 (%)</th>
                </tr>
              </thead>
              <tbody id="typeTableBody"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="card-body">
              <canvas id="typeChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- タブ6: 平均稼働ランキング -->
      <div class="tab-pane fade" id="ranking" role="tabpanel" aria-labelledby="ranking-tab">
        <div class="my-4">
          <h2 class="mb-4 text-center">平均稼働ランキング</h2>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="rankingTypeSelect" class="form-label">ランキングタイプ</label>
              <select id="rankingTypeSelect" class="form-select">
                <option value="all" selected>全店舗</option>
                <option value="industry">業種別</option>
              </select>
            </div>
            <div class="col-md-6" id="industryFilterDiv" style="display: none;">
              <label for="industrySelectRanking" class="form-label">業種を選択</label>
              <select id="industrySelectRanking" class="form-select">
                <!-- JSで動的に追加 -->
              </select>
              <div class="spinner-border text-primary" role="status" style="display:none;">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <button id="updateRankingBtn" class="btn btn-primary">ランキング更新</button>
          </div>
          <div class="table-responsive">
            <table id="rankingTable" class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>順位</th>
                  <th>店舗名</th>
                  <th>業種</th>
                  <th>ジャンル</th>
                  <th>エリア</th>
                  <th>平均稼働率 (%)</th>
                </tr>
              </thead>
              <tbody id="rankingTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div> <!-- /tab-content -->
  </div> <!-- /container-fluid -->

  <!-- 店舗詳細モーダル -->
  <div class="modal fade" id="storeDetailModal" tabindex="-1" aria-labelledby="storeDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="storeDetailModalLabel">店舗詳細</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <div id="storeDetailBasic"></div>
          <hr />
          <!-- モーダル内タブ：履歴グラフ・時間帯別分析 -->
          <ul class="nav nav-tabs" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="detail-history-tab" data-bs-toggle="tab" href="#detailHistory" role="tab">履歴グラフ</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="detail-hourly-tab" data-bs-toggle="tab" href="#detailHourly" role="tab">時間帯分析</a>
            </li>
          </ul>
          <div class="tab-content" id="detailTabsContent">
            <div class="tab-pane fade show active" id="detailHistory" role="tabpanel" aria-labelledby="detail-history-tab">
              <div class="chart-container">
                <canvas id="detailHistoryChart"></canvas>
              </div>
            </div>
            <div class="tab-pane fade" id="detailHourly" role="tabpanel" aria-labelledby="detail-hourly-tab">
              <div class="chart-container">
                <canvas id="detailHourlyChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 比較分析モーダル -->
  <div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="compareModalLabel">店舗比較分析</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <canvas id="compareChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast通知用コンテナ -->
  <div class="toast-container">
    <div id="updateToast" class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">新しいデータに更新しました！</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- jQuery, DataTables, Bootstrap JS, Socket.IO -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>

  <script>
    (function () {
      document.addEventListener("DOMContentLoaded", async () => {

        // ローディングスピナー操作関数
        function showSpinner() { document.getElementById("loadingSpinner").style.display = "block"; }
        function hideSpinner() { document.getElementById("loadingSpinner").style.display = "none"; }

        /***********************************************
         * fetchWithRetry: API呼び出しのリトライ処理
         ***********************************************/
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 2000) {
          for (let i = 0; i < retries; i++) {
            try {
              const response = await fetch(url, options);
              if (!response.ok) throw new Error("HTTP error " + response.status);
              return response;
            } catch (err) {
              console.error(`Fetch error (${url}), attempt ${i + 1}:`, err);
              if (i < retries - 1) await new Promise((resolve) => setTimeout(resolve, delay));
              else throw err;
            }
          }
        }

        /***********************************************
         * グローバル変数と初期設定
         ***********************************************/
        const charts = {
          currentRate: null,
          history: null,
          hourly: null,
          area: null,
          type: null,
          detailHistory: null,
          detailHourly: null,
          compare: null
        };
        let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
        let favoritesFilterActive = false;
        const savedIndustry = localStorage.getItem("industryFilter") || "";
        const savedHistoryStore = localStorage.getItem("historyStoreFilter") || "";
        const savedHourlyStore = localStorage.getItem("hourlyStoreFilter") || "";

        /***********************************************
         * ダークモード & お気に入りフィルタ
         ***********************************************/
        document.getElementById("darkModeToggle")?.addEventListener("click", () => {
          document.body.classList.toggle("dark");
          document.getElementById("pageHeader")?.classList.toggle("dark");
        });
        document.getElementById("favoritesToggle")?.addEventListener("click", () => {
          const rows = document.querySelectorAll("#storeTable tbody tr");
          favoritesFilterActive = !favoritesFilterActive;
          rows.forEach((row) => {
            const storeName = row.cells[1].innerText.trim();
            row.style.display = (favoritesFilterActive && !favorites.includes(storeName)) ? "none" : "";
          });
          document.getElementById("favoritesToggle").innerText = favoritesFilterActive ? "すべて表示" : "お気に入りのみ表示";
        });

        /***********************************************
         * CSVエクスポート機能
         ***********************************************/
        document.getElementById("exportCSV")?.addEventListener("click", () => {
          const rows = Array.from(document.querySelectorAll("#storeTable tr"));
          const csvContent = rows.map(row => Array.from(row.cells).map(cell => `"${cell.innerText.trim().replace(/"/g, '""')}"`).join(",")).join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "store_data.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        /***********************************************
         * updateDashboard: 店舗稼働状況更新 (/api/data)
         ***********************************************/
        async function updateDashboard() {
          try {
            // ページネーションなしで全データを取得（pageパラメータを指定しない）
            const response = await fetchWithRetry("/api/data", {}, 3, 2000);
            const responseJson = await response.json();
            const data = responseJson.data || responseJson; // 新旧APIの両方に対応

            // APIからメタデータを取得（バックエンドで計算された集計値）
            const meta = responseJson.meta || {}; 

            // 店舗数の表示（APIのメタデータから）
            document.getElementById("totalStores").innerText = meta.total_count || data.length;

            // 平均稼働率の表示（APIのメタデータから）
            document.getElementById("avgRate").innerText = (meta.avg_rate || 0).toFixed(1) + "%";

            // 最高稼働率の表示（APIのメタデータから）
            document.getElementById("maxRate").innerText = (meta.max_rate || 0).toFixed(1) + "%";

            const tableBody = document.getElementById("dataTable");
            tableBody.innerHTML = "";
            data.forEach((store) => {
              const rate = store.working_staff > 0 ? ((store.working_staff - store.active_staff) / store.working_staff * 100) : 0;
              const rateStr = rate.toFixed(1);
              const tagHtml = rate >= 50
                ? '<span class="badge bg-danger">高稼働</span>'
                : '<span class="badge bg-secondary">低稼働</span>';
              const isFav = favorites.includes(store.store_name);
              const rowHtml = `
                <tr>
                  <td>
                    <button class="favorite-btn btn btn-sm ${isFav ? "btn-warning" : "btn-outline-warning"}" data-store-name="${store.store_name}">★</button>
                    <input type="checkbox" class="compare-checkbox" data-store-name="${store.store_name}">
                  </td>
                  <td class="store-name clickable" data-store='${encodeURIComponent(JSON.stringify(store))}'>${store.store_name}</td>
                  <td>${store.biz_type || ""}</td>
                  <td>${store.genre || ""}</td>
                  <td>${store.area || ""}</td>
                  <td>${store.total_staff}</td>
                  <td>${store.working_staff}</td>
                  <td>${store.active_staff}</td>
                  <td>${rateStr}</td>
                  <td>${tagHtml}</td>
                  <td>--</td>
                  <td>--</td>
                </tr>`;
              tableBody.insertAdjacentHTML("beforeend", rowHtml);
            });
            if ($.fn.dataTable.isDataTable("#storeTable")) {
              $("#storeTable").DataTable().destroy();
            }
            $("#storeTable").DataTable({
              responsive: true,
              order: [[8, "desc"]],
              language: { search: "検索:" }
            });
            $("#storeTable tbody").off("click", ".favorite-btn").on("click", ".favorite-btn", function (e) {
              e.stopPropagation();
              const storeName = $(this).data("store-name");
              if (favorites.includes(storeName)) {
                favorites = favorites.filter(n => n !== storeName);
                $(this).removeClass("btn-warning").addClass("btn-outline-warning");
              } else {
                favorites.push(storeName);
                $(this).removeClass("btn-outline-warning").addClass("btn-warning");
              }
              localStorage.setItem("favorites", JSON.stringify(favorites));
            });
            $("#storeTable tbody").off("click", ".store-name.clickable").on("click", ".store-name.clickable", function () {
              const store = JSON.parse(decodeURIComponent($(this).data("store")));
              const content = `
                <strong>店舗名:</strong> ${store.store_name}<br>
                <strong>業種:</strong> ${store.biz_type || "不明"}<br>
                <strong>ジャンル:</strong> ${store.genre || "不明"}<br>
                <strong>エリア:</strong> ${store.area || "不明"}<br>
                <strong>総出勤:</strong> ${store.total_staff}<br>
                <strong>勤務中人数:</strong> ${store.working_staff}<br>
                <strong>即ヒメ人数:</strong> ${store.active_staff}<br>
                <strong>店舗URL:</strong> <a href="${store.url}" target="_blank">${store.url}</a>
              `;
              $("#storeDetailBasic").html(content);
              updateDetailHistoryChart(store.store_name);
              updateDetailHourlyChart(store.store_name);
              new bootstrap.Modal(document.getElementById("storeDetailModal")).show();
            });
          } catch (error) {
            console.error("APIデータ取得エラー:", error);
          }
        }

        /***********************************************
         * updateTop10Chart: トップ10店舗グラフ更新 (/api/data)
         ***********************************************/
        async function updateTop10Chart() {
          try {
            const response = await fetchWithRetry("/api/data", {}, 3, 2000);
            const data = await response.json();
            data.forEach(store => {
              store.currentRate = store.working_staff > 0 ? ((store.working_staff - store.active_staff) / store.working_staff * 100).toFixed(1) : 0;
            });
            const topData = data.sort((a, b) => b.currentRate - a.currentRate).slice(0, 10);
            const labels = topData.map(store => store.store_name);
            const rates = topData.map(store => store.currentRate);
            const ctx = document.getElementById("currentRateChart").getContext("2d");
            if (charts.currentRate) charts.currentRate.destroy();
            charts.currentRate = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [{
                  label: "現在稼働率 (%)",
                  data: rates,
                  backgroundColor: "rgba(75, 192, 192, 0.7)",
                  borderColor: "rgba(75, 192, 192, 1)",
                  borderWidth: 1
                }]
              },
              options: {
                indexAxis: "y",
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: "トップ10店舗の現在稼働率",
                    font: { size: 20 }
                  },
                  tooltip: { callbacks: { label: context => `${context.parsed.x}%` } },
                  zoom: {
                    pan: { enabled: true, mode: 'xy' },
                    zoom: { enabled: true, mode: 'xy' }
                  },
                  legend: { display: false }
                },
                scales: {
                  x: { beginAtZero: true, max: 100, title: { display: true, text: "稼働率(%)" } },
                  y: { ticks: { font: { size: 12 } } }
                },
                animation: { duration: 1000 }
              }
            });
          } catch (error) {
            console.error("トップ10店舗グラフエラー:", error);
          }
        }

        /***********************************************
         * updateHistoryChart: 店舗履歴グラフ更新 (/api/history or /api/aggregated)
         ***********************************************/
        let historyChartCache = {}; // キャッシュ用オブジェクト

        async function updateHistoryChart() {
          try {
            showSpinner();
            const storeSelect = document.getElementById("storeSelectHistory");
            if(storeSelect) { storeSelect.value = savedHistoryStore; }
            const selectedStore = storeSelect ? storeSelect.value : "";
            const startDate = document.getElementById("startDate")?.value || "";
            const endDate = document.getElementById("endDate")?.value || "";

            // キャッシュキーを作成
            const cacheKey = `${selectedStore}_${startDate}_${endDate}`;

            // キャッシュがあれば使用
            if (historyChartCache[cacheKey]) {
              const cachedData = historyChartCache[cacheKey];
              updateHistoryChartDisplay(cachedData.labels, cachedData.effectiveRates);
              hideSpinner();
              return;
            }

            let labels = [];
            let effectiveRates = [];

            // 最適化: 集計済みデータを使用するかフィルタリングしたデータを使用するか決定
            if (selectedStore || (startDate && endDate)) {
              // 個別店舗指定、または期間指定の場合: フィルター付きでhistoryAPIを呼び出し
              let url = "/api/history?";
              const params = new URLSearchParams();

              if (selectedStore) params.append("store", selectedStore);
              if (startDate) params.append("start_date", startDate);
              if (endDate) params.append("end_date", endDate);
              // サンプル数を制限してパフォーマンス改善
              params.append("limit", "2000");

              const response = await fetchWithRetry(url + params.toString(), {}, 3, 2000);
              const data = await response.json();
              console.log("History API response:", data);

              if (selectedStore) {
                // 単一店舗の場合は時間まで表示
                labels = data.map(record => {
                  const d = new Date(record.timestamp);
                  return d.toLocaleDateString() + " " + d.toTimeString().substring(0, 5);
                });
                effectiveRates = data.map(record => 
                  record.rate ? record.rate.toFixed(1) : 
                  (record.working_staff > 0 ? 
                  ((record.working_staff - record.active_staff) / record.working_staff* 100).toFixed(1) : 0)
                );
              } else {                // 全店舗かつ期間指定の場合は日付で集計
                const dateMap = new Map();

                data.forEach(record => {
                  const d = new Date(record.timestamp);
                  const dateKey = d.toLocaleDateString();

                  if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, { sum: 0, count: 0 });
                  }

                  // 稼働率を取得（既に計算済みのrateフィールドか、計算する）
                  const rate = record.rate ? record.rate :
                    (record.working_staff > 0 ? 
                    ((record.working_staff - record.active_staff) / record.working_staff * 100) : 0);

                  if (rate > 0) {
                    dateMap.get(dateKey).sum += rate;
                    dateMap.get(dateKey).count += 1;
                  }
                });

                // 日付でソート
                const sortedDates = Array.from(dateMap.keys()).sort((a, b) => new Date(a) - new Date(b));

                labels = sortedDates;
                effectiveRates = sortedDates.map(date => {
                  const entry = dateMap.get(date);
                  return entry.count > 0 ? (entry.sum / entry.count).toFixed(1) : "0.0";
                });
              }
            } else {
              // 期間指定がなく全店舗の場合: 事前集計データを使用
              const response = await fetchWithRetry("/api/aggregated", {}, 3, 2000);
              const data = await response.json();
              console.log("Aggregated API response:", data);

              // 日付ごとに集計
              const dateMap = new Map();

              data.forEach(entry => {
                const dateKey = entry.date;

                if (!dateMap.has(dateKey)) {
                  dateMap.set(dateKey, { sum: 0, count: 0, rateSum: 0, rateSamples: 0 });
                }

                const mapEntry = dateMap.get(dateKey);
                mapEntry.sum += entry.avg_rate * entry.sample_count; // 加重平均のため
                mapEntry.count += entry.sample_count;
                mapEntry.rateSum += entry.avg_rate;
                mapEntry.rateSamples += 1;
              });

              // 日付でソート
              const sortedDates = Array.from(dateMap.keys()).sort();

              labels = sortedDates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString();
              });

              effectiveRates = sortedDates.map(date => {
                const entry = dateMap.get(date);
                // 加重平均を使用（サンプル数で重み付け）
                return entry.count > 0 ? (entry.sum / entry.count).toFixed(1) : "0.0";
              });
            }

            const ctx = document.getElementById("historyChart").getContext("2d");
            if (charts.history) charts.history.destroy();

            charts.history = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [{
                  label: "実働率 (%)",
                  data: effectiveRates,
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  fill: false,
                  tension: 0.3,
                  pointRadius: labels.length > 100 ? 0 : 3, // データ点が多い場合は非表示に
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: (selectedStore === "") 
                          ? "全店舗の平均稼働率（期間指定）"
                          : `店舗(${selectedStore})の履歴グラフ`,
                    font: { size: 20 }
                  },
                  tooltip: { callbacks: { label: context => `${context.parsed.y}%` } },
                  zoom: {
                    pan: { enabled: true, mode: 'xy' },
                    zoom: { enabled: true, mode: 'xy' }
                  }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "実働率 (%)" } },
                  x: { 
                    title: { display: true, text: "日時" },
                    // データが多い場合に表示を間引く
                    ticks: {
                      maxTicksLimit: Math.min(labels.length, 20)  // 最大20目盛りに制限
                    }
                  }
                },
                animation: { duration: 500 } // アニメーション時間短縮
              }
            });

            const historyStats = document.getElementById("historyStats");
            if (effectiveRates.length > 0) {
              const numericRates = effectiveRates.map(Number);
              const overallAvg = numericRates.reduce((a, b) => a + b, 0) / numericRates.length;
              historyStats.textContent = `期間内サンプル数: ${numericRates.length} / 平均稼働率: ${overallAvg.toFixed(1)}%`;
            } else {
              historyStats.textContent = "該当データなし";
            }
            // キャッシュに保存
            historyChartCache[cacheKey] = { labels, effectiveRates };

            // チャート更新処理
            updateHistoryChartDisplay(labels, effectiveRates);

            hideSpinner();
          } catch (error) {
            console.error("履歴グラフエラー:", error);
            console.error(error.stack);
            hideSpinner();
          }
        }

        // チャート表示処理を別関数に分離
        function updateHistoryChartDisplay(labels, effectiveRates) {
            const ctx = document.getElementById("historyChart").getContext("2d");
            if (charts.history) charts.history.destroy();

            charts.history = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [{
                  label: "実働率 (%)",
                  data: effectiveRates,
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  fill: false,
                  tension: 0.3,
                  pointRadius: labels.length > 100 ? 0 : 3, // データ点が多い場合は非表示に
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: (document.getElementById("storeSelectHistory")?.value === "") 
                          ? "全店舗の平均稼働率（期間指定）"
                          : `店舗(${document.getElementById("storeSelectHistory")?.value})の履歴グラフ`,
                    font: { size: 20 }
                  },
                  tooltip: { callbacks: { label: context => `${context.parsed.y}%` } },
                  zoom: {
                    pan: { enabled: true, mode: 'xy' },
                    zoom: { enabled: true, mode: 'xy' }
                  }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "実働率 (%)" } },
                  x: { 
                    title: { display: true, text: "日時" },
                    // データが多い場合に表示を間引く
                    ticks: {
                      maxTicksLimit: Math.min(labels.length, 20)  // 最大20目盛りに制限
                    }
                  }
                },
                animation: { duration: 500 } // アニメーション時間短縮
              }
            });

            const historyStats = document.getElementById("historyStats");
            if (effectiveRates.length > 0) {
              const numericRates = effectiveRates.map(Number);
              const overallAvg = numericRates.reduce((a, b) => a + b, 0) / numericRates.length;
              historyStats.textContent = `期間内サンプル数: ${numericRates.length} / 平均稼働率: ${overallAvg.toFixed(1)}%`;
            } else {
              historyStats.textContent = "該当データなし";
            }
        }
        document.getElementById("updateHistoryBtn")?.addEventListener("click", updateHistoryChart);

        /***********************************************
         * fillHistoryStoreDropdown: 履歴グラフ用店舗ドロップダウン更新
         ***********************************************/
        async function fillHistoryStoreDropdown() {
          try {
            showSpinner();
            const response = await fetchWithRetry("/api/history", {}, 3, 2000);
            const data = await response.json();
            console.log("History store data:", data);

            const storeSelect = document.getElementById("storeSelectHistory");
            if (!storeSelect) {
              hideSpinner();
              return;
            }

            const stores = new Set();
            data.forEach(item => { 
              if (item.store_name) stores.add(item.store_name); 
            });

            console.log(`Found ${stores.size} unique stores`);
            storeSelect.innerHTML = '<option value="">全店舗</option>';

            const sortedStores = Array.from(stores).sort();
            sortedStores.forEach(store => {
              storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
            });

            storeSelect.value = savedHistoryStore;
            storeSelect.addEventListener("change", () => { 
              localStorage.setItem("historyStoreFilter", storeSelect.value); 
            });

            hideSpinner();
          } catch (err) {
            console.error("履歴グラフ店舗リスト取得エラー:", err);
            console.error(err.stack);
            hideSpinner();
          }
        }

        /***********************************************
         * updateHourlyAnalysis: 時間帯別分析更新 (/api/history)
         ***********************************************/
        async function updateHourlyAnalysis() {
          try {
            showSpinner();
            const response = await fetchWithRetry("/api/history", {}, 3, 2000);
            const data = await response.json();
            console.log("Hourly analysis data:", data);

            const hourlyStoreSelect = document.getElementById("hourlyStoreSelect");
            if(hourlyStoreSelect) {
              hourlyStoreSelect.value = savedHourlyStore;
              hourlyStoreSelect.addEventListener("change", () => { localStorage.setItem("hourlyStoreFilter", hourlyStoreSelect.value); });
            }
            const selectedStore = hourlyStoreSelect ? hourlyStoreSelect.value : "";
            let filtered = selectedStore ? data.filter(record => record.store_name === selectedStore) : data;

            const hourly = {};
            filtered.forEach(record => {
              // 稼働率を取得（既に計算済みのrateフィールドか、計算する）
              if (record.working_staff > 0) {
                const d = new Date(record.timestamp);
                const hour = d.getHours();
                const rate = record.rate ? record.rate : 
                  ((record.working_staff - record.active_staff) / record.working_staff) * 100;

                if (!hourly[hour]) hourly[hour] = { sum: 0, count: 0 };
                hourly[hour].sum += rate;
                hourly[hour].count += 1;
              }
            });

            const labels = [];
            const avgRates = [];
            for (let h = 0; h < 24; h++) {
              labels.push(`${h}:00`);
              avgRates.push(hourly[h] && hourly[h].count > 0 ? (hourly[h].sum / hourly[h].count).toFixed(1) : "0");
            }

            const ctx = document.getElementById("hourlyChart").getContext("2d");
            if (charts.hourly) charts.hourly.destroy();

            charts.hourly = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [{
                  label: "平均実働率 (%)",
                  data: avgRates,
                  borderColor: "rgba(255, 159, 64, 1)",
                  backgroundColor: "rgba(255, 159, 64, 0.2)",
                  fill: false,
                  tension: 0.3,
                  pointRadius: 3,
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  title: { display: true, text: "時間帯別分析", font: { size: 20 } },
                  tooltip: { callbacks: { label: context => `${context.parsed.y}%` } },
                  zoom: { pan: { enabled: true, mode: 'xy' }, zoom: { enabled: true, mode: 'xy' } }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "実働率 (%)" } },
                  x: { title: { display: true, text: "時間帯" } }
                },
                animation: { duration: 1000 }
              }
            });
            hideSpinner();
          } catch (err) {
            console.error("時間帯別分析エラー:", err);
            console.error(err.stack);
            hideSpinner();
          }
        }
        document.getElementById("updateHourlyBtn")?.addEventListener("click", updateHourlyAnalysis);

        /***********************************************
         * fillHourlyStoreDropdown: 時間帯分析用店舗ドロップダウン更新
         ***********************************************/
        async function fillHourlyStoreDropdown() {
          try {
            showSpinner();
            const response = await fetchWithRetry("/api/history", {}, 3, 2000);
            const data = await response.json();
            console.log("Hourly store data:", data);

            const hourlyStoreSelect = document.getElementById("hourlyStoreSelect");
            if (!hourlyStoreSelect) {
              hideSpinner();
              return;
            }

            const stores = new Set();
            data.forEach(item => { 
              if (item.store_name) stores.add(item.store_name); 
            });

            console.log(`Found ${stores.size} unique stores for hourly dropdown`);
            hourlyStoreSelect.innerHTML = '<option value="">全店舗</option>';

            const sortedStores = Array.from(stores).sort();
            sortedStores.forEach(store => { 
              hourlyStoreSelect.innerHTML += `<option value="${store}">${store}</option>`; 
            });

            hourlyStoreSelect.value = savedHourlyStore;
            hideSpinner();
          } catch (err) {
            console.error("時間帯分析店舗リスト取得エラー:", err);
            console.error(err.stack);
            hideSpinner();
          }
        }

        /***********************************************
         * updateAreaStatistics: エリア統計更新
         * ・店舗数は /api/data から取得
         * ・平均稼働率は /api/history から計算
         ***********************************************/
        async function updateAreaStatistics() {
          try {
            showSpinner();
            // /api/data から最新データを取得し、各エリアの店舗数をカウント
            const responseData = await fetchWithRetry("/api/data", {}, 3, 2000);
            const responseJson = await responseData.json();
            const dataLatest = responseJson.data || responseJson; // API形式に対応
            console.log("Area stats data latest:", dataLatest);

            const areaStoreCount = {};
            dataLatest.forEach(store => {
              const area = store.area || "不明";
              if (!areaStoreCount[area]) { areaStoreCount[area] = 0; }
              areaStoreCount[area]++;
            });

            // /api/history から履歴データを取得し、各エリアの平均稼働率を計算
            const responseHistory = await fetchWithRetry("/api/history", {}, 3, 2000);
            const dataHistory = await responseHistory.json();
            console.log("Area stats history data:", dataHistory);

            const areaRateData = {};
            dataHistory.forEach(record => {
              const area = record.area || "不明";

              // 稼働率をレコードから取得または計算
              let rate = 0;
              if (record.rate) {
                rate = record.rate; // API形式に対応
              } else if (record.working_staff > 0) {
                rate = ((record.working_staff - record.active_staff) / record.working_staff * 100);
              }

              if (rate > 0) {
                if (!areaRateData[area]) {
                  areaRateData[area] = { totalRate: 0, count: 0 };
                }
                areaRateData[area].totalRate += rate;
                areaRateData[area].count++;
              }
            });

            // テーブル表示用に、両方のデータを統合
            const areaTable = document.getElementById("areaTable");
            if (!areaTable) {
              console.error("areaTable element not found");
              hideSpinner();
              return;
            }

            areaTable.innerHTML = "";
            const labels = [];
            const avgRates = [];
            const allAreas = new Set([...Object.keys(areaStoreCount), ...Object.keys(areaRateData)]);

            allAreas.forEach(area => {
              const storeCount = areaStoreCount[area] || 0;
              const rateData = areaRateData[area] || { totalRate: 0, count: 0 };
              const avgRate = rateData.count > 0 ? (rateData.totalRate / rateData.count).toFixed(1) : "0.0";

              areaTable.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${area}</td>
                  <td>${storeCount}</td>
                  <td>${avgRate}</td>
                </tr>
              `);

              labels.push(area);
              avgRates.push(parseFloat(avgRate));
            });

            const ctx = document.getElementById("areaChart").getContext("2d");
            if (!ctx) {
              console.error("areaChart canvas context not found");
              hideSpinner();
              return;
            }

            if (charts.area) charts.area.destroy();

            charts.area = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [{
                  label: "平均稼働率 (%)",
                  data: avgRates,
                  backgroundColor: "rgba(153, 102, 255, 0.7)",
                  borderColor: "rgba(153, 102, 255, 1)",
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  title: { display: true, text: "エリア別平均稼働率", font: { size: 18 } }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "平均稼働率 (%)" } }
                }
              }
            });

            hideSpinner();
          } catch (error) {
            console.error("エリア統計エラー:", error);
            console.error(error.stack);
            hideSpinner();
          }
        }

        /***********************************************
         * fillIndustryDropdown: 業種内ジャンルランキング用ドロップダウン更新
         ***********************************************/
        async function fillIndustryDropdown() {
          try {
            const responseLatest = await fetchWithRetry("/api/data", {}, 3, 2000);
            const dataLatest = await responseLatest.json();
            const industries = new Set();
            dataLatest.forEach(item => { if(item.biz_type && item.biz_type !== "不明") industries.add(item.biz_type); });
            const industrySelect = document.getElementById("industrySelectType");
            if (!industrySelect) return;
            industrySelect.innerHTML = "";
            industries.forEach(ind => { industrySelect.innerHTML += `<option value="${ind}">${ind}</option>`; });
            industrySelect.value = savedIndustry;
            industrySelect.addEventListener("change", () => {
              localStorage.setItem("industryFilter", industrySelect.value);
              updateIndustryRanking();
            });
          } catch (err) {
            console.error("業種ドロップダウン取得エラー:", err);
          }
        }

        async function updateIndustryRanking() {
          try {
            const industrySelect = document.getElementById("industrySelectType");
            const selectedIndustry = industrySelect ? industrySelect.value : "";
            const responseLatest = await fetchWithRetry("/api/data", {}, 3, 2000);
            const dataLatest = await responseLatest.json();
            const latestStoreNames = new Set(dataLatest.map(store => store.store_name));
            const responseHistory = await fetchWithRetry("/api/history", {}, 3, 2000);
            const dataHistory = await responseHistory.json();
            const filtered = dataHistory.filter(record => latestStoreNames.has(record.store_name) &&
              (selectedIndustry ? record.biz_type === selectedIndustry : true));
            const genreData = {};
            filtered.forEach(record => {
              const genre = record.genre || "不明";
              if (!genreData[genre]) { genreData[genre] = { stores: new Set(), totalRate: 0, rateCount: 0 }; }
              genreData[genre].stores.add(record.store_name);
              if (record.working_staff > 0) {
                genreData[genre].totalRate += ((record.working_staff - record.active_staff) / record.working_staff * 100);
                genreData[genre].rateCount += 1;
              }
            });
            const typeTable = document.getElementById("typeTable");
            typeTable.innerHTML = "";
            const labels = [];
            const avgRates = [];
            for (const g in genreData) {
              const { stores, totalRate, rateCount } = genreData[g];
              const storeCount = stores.size;
              const avgRate = rateCount > 0 ? (totalRate / rateCount).toFixed(1) : "0.0";
              typeTable.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${g}</td>
                  <td>${storeCount}</td>
                  <td>${avgRate}</td>
                </tr>
              `);
              labels.push(g);
              avgRates.push(parseFloat(avgRate));
            }
            const ctx = document.getElementById("typeChart").getContext("2d");
            if (charts.type) charts.type.destroy();
            charts.type = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [{
                  label: "平均稼働率 (%)",
                  data: avgRates,
                  backgroundColor: "rgba(255, 206, 86, 0.7)",
                  borderColor: "rgba(255, 206, 86, 1)",
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "平均稼働率 (%)" } }
                }
              }
            });
          } catch (error) {
            console.error("業種内ジャンルランキングエラー:", error);
          }
        }

        /***********************************************
         * updateDetailHistoryChart: 店舗詳細モーダル内履歴グラフ更新 (/api/history)
         ***********************************************/
        async function updateDetailHistoryChart(storeName) {
          try {
            const response = await fetchWithRetry("/api/history", {}, 3, 2000);
            const data = await response.json();
            const filtered = data.filter(record => record.store_name === storeName)
                                 .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const labels = filtered.map(record => {
              const d = new Date(record.timestamp);
              return d.toLocaleDateString() + " " + d.toTimeString().substring(0, 5);
            });
            const effectiveRates = filtered.map(record => record.working_staff > 0 ? ((record.working_staff - record.active_staff) / record.working_staff * 100).toFixed(1) : 0);
            const ctx = document.getElementById("detailHistoryChart").getContext("2d");
            if (charts.detailHistory) charts.detailHistory.destroy();
            charts.detailHistory = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [{
                  label: "実働率 (%)",
                  data: effectiveRates,
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  fill: false,
                  tension: 0.3,
                  pointRadius: 3,
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  title: { display: true, text: "店舗履歴グラフ", font: { size: 20 } },
                  tooltip: { callbacks: { label: context => `${context.parsed.y}%` } },
                  zoom: { pan: { enabled: true, mode: 'xy' }, zoom: { enabled: true, mode: 'xy' } }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "実働率 (%)" } },
                  x: { title: { display: true, text: "日時" } }
                },
                animation: { duration: 1000 }
              }
            });
          } catch (error) {
            console.error("店舗詳細履歴グラフエラー:", error);
          }
        }

        /***********************************************
         * updateDetailHourlyChart: 店舗詳細モーダル内時間帯分析更新 (/api/history)
         ***********************************************/
        async function updateDetailHourlyChart(storeName) {
          try {
            const response = await fetchWithRetry("/api/history", {}, 3, 2000);
            const data = await response.json();
            const filtered = data.filter(record => record.store_name === storeName);
            const hourly = {};
            filtered.forEach(record => {
              if (record.working_staff > 0) {
                const d = new Date(record.timestamp);
                const hour = d.getHours();
                const rate = ((record.working_staff - record.active_staff) / record.working_staff) * 100;
                if (!hourly[hour]) hourly[hour] = { sum: 0, count: 0 };
                hourly[hour].sum += rate;
                hourly[hour].count += 1;
              }
            });
            const labels = [];
            const avgRates = [];
            for (let h = 0; h < 24; h++) {
              labels.push(`${h}:00`);
              avgRates.push(hourly[h] && hourly[h].count > 0 ? (hourly[h].sum / hourly[h].count).toFixed(1) : "0");
            }
            const ctx = document.getElementById("detailHourlyChart").getContext("2d");
            if (charts.detailHourly) charts.detailHourly.destroy();
            charts.detailHourly = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [{
                  label: "平均実働率 (%)",
                  data: avgRates,
                  borderColor: "rgba(54, 162, 235, 1)",
                  backgroundColor: "rgba(54, 162, 235, 0.2)",
                  fill: false,
                  tension: 0.3,
                  pointRadius: 3,
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  title: { display: true, text: "店舗詳細 時間帯別分析", font: { size: 20 } },
                  tooltip: { callbacks: { label: context => `${context.parsed.y}%` } },
                  zoom: { pan: { enabled: true, mode: 'xy' }, zoom: { enabled: true, mode: 'xy' } }
                },
                scales: {
                  y: { beginAtZero: true, max: 100, title: { display: true, text: "実働率 (%)" } },
                  x: { title: { display: true, text: "時間帯" } }
                },
                animation: { duration: 1000 }
              }
            });
          } catch (err) {
            console.error("店舗詳細時間帯分析エラー:", err);
          }
        }

        /***********************************************
         * updateAverageRanking: 平均稼働ランキング更新 (/api/ranking/average)
         ***********************************************/
        async function updateAverageRanking() {
          try {
            showSpinner();
            const rankingType = document.getElementById("rankingTypeSelect").value;
            let apiUrl = "/api/ranking/average";

            if (rankingType === "industry") {
              const selectedIndustry = document.getElementById("industrySelectRanking").value;
              apiUrl += `?biz_type=${encodeURIComponent(selectedIndustry)}`;
            }

            const response = await fetchWithRetry(apiUrl, {}, 3, 2000);
            const rankingData = await response.json();

            // 前処理済みデータをそのまま使用
            const tbody = document.getElementById("rankingTableBody");
            tbody.innerHTML = "";

            rankingData.forEach((store, index) => {
              const rowHtml = `
                <tr>
                  <td>${index + 1}</td>
                  <td>${store.store_name}</td>
                  <td>${store.biz_type}</td>
                  <td>${store.genre}</td>
                  <td>${store.area}</td>
                  <td>${store.avg_rate.toFixed(1)}</td>
                </tr>
              `;
              tbody.insertAdjacentHTML("beforeend", rowHtml);
            });
            hideSpinner();
          } catch (error) {
            console.error("平均稼働ランキングエラー:", error);
            hideSpinner();
          }
        }

        /***********************************************
         * fillIndustryDropdownForRanking: 業種別ランキング用ドロップダウン更新
         ***********************************************/
        async function fillIndustryDropdownForRanking() {
          try {
            // 最適化: 現在のデータから業種を取得（履歴全件不要）
            const response = await fetchWithRetry("/api/data", {}, 3, 2000);
            const data = await response.json();
            const industries = new Set();

            data.forEach(record => { 
              if (record.biz_type) industries.add(record.biz_type); 
            });

            const industrySelect = document.getElementById("industrySelectRanking");
            industrySelect.innerHTML = "";

            // 業種でソート
            const sortedIndustries = Array.from(industries).sort();
            sortedIndustries.forEach(ind => { 
              industrySelect.innerHTML += `<option value="${ind}">${ind}</option>`; 
            });

            // ローカルストレージから前回の選択を復元
            const savedIndustryRanking = localStorage.getItem("industryRankingFilter");
            if (savedIndustryRanking && sortedIndustries.includes(savedIndustryRanking)) {
              industrySelect.value = savedIndustryRanking;
            }

            // 選択変更時の保存処理
            industrySelect.addEventListener("change", () => {
              localStorage.setItem("industryRankingFilter", industrySelect.value);
            });
          } catch (err) {
            console.error("ランキング業種ドロップダウン取得エラー:", err);
          }
        }

        // ランキングタイプ変更イベント
        document.getElementById("rankingTypeSelect").addEventListener("change", async function() {
          if (this.value === "industry") {
            document.getElementById("industryFilterDiv").style.display = "";
            await fillIndustryDropdownForRanking();
          } else {
            document.getElementById("industryFilterDiv").style.display = "none";
          }
        });
        document.getElementById("updateRankingBtn").addEventListener("click", updateAverageRanking);

        /***********************************************
         * Socket.IOによるリアルタイム更新とトースト通知
         ***********************************************/
        const socket = io();
        socket.on("update", (msg) => {
          console.log("Socket update received:", msg.data);
          updateDashboard();
          updateTop10Chart();
          updateAreaStatistics();
          updateIndustryRanking();
          const toastEl = document.getElementById("updateToast");
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        });

        /***********************************************
         * 初期ロード処理
         ***********************************************/
        updateDashboard();
        updateTop10Chart();
        updateAreaStatistics();
        await fillIndustryDropdown();
        updateIndustryRanking();
        await fillHistoryStoreDropdown();
        updateHistoryChart();
        await fillHourlyStoreDropdown();
        updateHourlyAnalysis();
        // タブ切り替え処理
        document.querySelectorAll('.nav-link').forEach(button => {
          button.addEventListener('click', function() {
            // すべてのタブボタンから active クラスを削除
            document.querySelectorAll('.nav-link').forEach(btn => {
              btn.classList.remove('active');
            });

            // クリックされたボタンに active クラスを追加
            this.classList.add('active');

            // すべてのタブコンテンツを非表示
            document.querySelectorAll('.tab-pane').forEach(content => {
              content.classList.remove('show', 'active');
            });

            // クリックされたボタンのターゲットコンテンツを表示
            const targetId = this.getAttribute('href');
            document.querySelector(targetId).classList.add('show', 'active');

            // 業種内ジャンルランキングのタブが選択された場合
            if (targetId === '#type') {
              loadBusinessTypes('industrySelectType');
              updateTypeRanking();
            }

            // 平均稼働ランキングのタブが選択された場合
            if (targetId === '#ranking') {
              loadBusinessTypes('industrySelectRanking');
              updateRanking();
            }
          });
        });

        // 業種データをロードして選択ボックスに反映する共通関数
        function loadBusinessTypes(selectId) {
          const select = document.getElementById(selectId);
          if (!select.options.length) {
            // 業種データが未読み込みの場合のみ実行
            fetch('/api/data')
              .then(response => response.json())
              .then(data => {
                // 重複のないbiz_typeリストを作成
                const bizTypes = [...new Set(data.data.map(item => item.biz_type))].filter(Boolean);
                bizTypes.sort();

                // 選択肢をクリア
                select.innerHTML = '';

                // 業種選択肢を追加
                bizTypes.forEach(type => {
                  const option = document.createElement('option');
                  option.value = type;
                  option.textContent = type;
                  select.appendChild(option);
                });

                // デフォルト値を選択
                if (bizTypes.length > 0) {
                  select.value = bizTypes[0];
                }
              })
              .catch(error => console.error('業種データ取得エラー:', error));
          }
        }

        // 業種内ジャンルランキング更新
        function updateTypeRanking() {
          const selectedBizType = document.getElementById('industrySelectType').value;
          if (!selectedBizType) return;

          const tableBody = document.getElementById('typeTableBody');
          const chartCanvas = document.getElementById('typeChart');
          const loadingSpinner = document.querySelector('#type .spinner-border');

          // ローディング表示
          if (loadingSpinner) loadingSpinner.style.display = 'inline-block';

          // APIからデータを取得
          fetch(`/api/ranking/genre?biz_type=${encodeURIComponent(selectedBizType)}`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`API応答エラー: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              console.log('業種内ジャンルランキングデータ:', data);

              // テーブル表示
              tableBody.innerHTML = '';

              if (!Array.isArray(data) || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">該当するデータがありません</td></tr>';
                return;
              }

              data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${item.genre || '不明'}</td>
                  <td>${item.store_count}</td>
                  <td>${item.avg_rate}%</td>
                `;
                tableBody.appendChild(row);
              });

              // グラフ表示
              if (charts.type) charts.type.destroy();

              const ctx = chartCanvas.getContext('2d');
              charts.type = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: data.map(item => item.genre || '不明'),
                  datasets: [{
                    label: '平均稼働率 (%)',
                    data: data.map(item => item.avg_rate),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 100
                    }
                  },
                  plugins: {
                    title: {
                      display: true,
                      text: `「${selectedBizType}」業種内ジャンルの平均稼働率`,
                      font: {
                        size: 16
                      }
                    }
                  }
                }
              });
            })
            .catch(error => {
              console.error('ジャンルランキング取得エラー:', error);
              tableBody.innerHTML = '<tr><td colspan="4" class="text-center">データ取得中にエラーが発生しました</td></tr>';
              // エラーの詳細をコンソールに出力
              console.error('エラー詳細:', error.stack);
            })
            .finally(() => {
              // ローディング非表示
              if (loadingSpinner) loadingSpinner.style.display = 'none';
            });
        }

        // 業種選択変更時のイベント
        document.getElementById('industrySelectType')?.addEventListener('change', updateTypeRanking);


        /***********************************************
         * updateAverageRanking: 平均稼働ランキング更新 (/api/ranking/average)
         ***********************************************/
        async function updateAverageRanking() {
          try {
            showSpinner();
            const rankingType = document.getElementById("rankingTypeSelect").value;
            let apiUrl = "/api/ranking/average";

            if (rankingType === "industry") {
              const selectedIndustry = document.getElementById("industrySelectRanking").value;
              apiUrl += `?biz_type=${encodeURIComponent(selectedIndustry)}`;
            }

            const response = await fetchWithRetry(apiUrl, {}, 3, 2000);
            const rankingData = await response.json();

            // 前処理済みデータをそのまま使用
            const tbody = document.getElementById("rankingTableBody");
            tbody.innerHTML = "";

            rankingData.forEach((store, index) => {
              const rowHtml = `
                <tr>
                  <td>${index + 1}</td>
                  <td>${store.store_name}</td>
                  <td>${store.biz_type}</td>
                  <td>${store.genre}</td>
                  <td>${store.area}</td>
                  <td>${store.avg_rate.toFixed(1)}</td>
                </tr>
              `;
              tbody.insertAdjacentHTML("beforeend", rowHtml);
            });
            hideSpinner();
          } catch (error) {
            console.error("平均稼働ランキングエラー:", error);
            hideSpinner();
          }
        }

        /***********************************************
         * fillIndustryDropdownForRanking: 業種別ランキング用ドロップダウン更新
         ***********************************************/
        async function fillIndustryDropdownForRanking() {
          try {
            // 最適化: 現在のデータから業種を取得（履歴全件不要）
            const response = await fetchWithRetry("/api/data", {}, 3, 2000);
            const data = await response.json();
            const industries = new Set();

            data.forEach(record => { 
              if (record.biz_type) industries.add(record.biz_type); 
            });

            const industrySelect = document.getElementById("industrySelectRanking");
            industrySelect.innerHTML = "";

            // 業種でソート
            const sortedIndustries = Array.from(industries).sort();
            sortedIndustries.forEach(ind => { 
              industrySelect.innerHTML += `<option value="${ind}">${ind}</option>`; 
            });

            // ローカルストレージから前回の選択を復元
            const savedIndustryRanking = localStorage.getItem("industryRankingFilter");
            if (savedIndustryRanking && sortedIndustries.includes(savedIndustryRanking)) {
              industrySelect.value = savedIndustryRanking;
            }

            // 選択変更時の保存処理
            industrySelect.addEventListener("change", () => {
              localStorage.setItem("industryRankingFilter", industrySelect.value);
            });
          } catch (err) {
            console.error("ランキング業種ドロップダウン取得エラー:", err);
          }
        }

        // ランキングタイプ変更イベント
        document.getElementById("rankingTypeSelect").addEventListener("change", async function() {
          if (this.value === "industry") {
            document.getElementById("industryFilterDiv").style.display = "";
            await fillIndustryDropdownForRanking();
          } else {
            document.getElementById("industryFilterDiv").style.display = "none";
          }
        });
        document.getElementById("updateRankingBtn").addEventListener("click", updateAverageRanking);

        /***********************************************
         * Socket.IOによるリアルタイム更新とトースト通知
         ***********************************************/
        const socket = io();
        socket.on("update", (msg) => {
          console.log("Socket update received:", msg.data);
          updateDashboard();
          updateTop10Chart();
          updateAreaStatistics();
          updateIndustryRanking();
          const toastEl = document.getElementById("updateToast");
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        });

        /***********************************************
         * 初期ロード処理
         ***********************************************/
        updateDashboard();
        updateTop10Chart();
        updateAreaStatistics();
        await fillIndustryDropdown();
        updateIndustryRanking();
        await fillHistoryStoreDropdown();
        updateHistoryChart();
        await fillHourlyStoreDropdown();
        updateHourlyAnalysis();
        // タブ切り替え処理
        document.querySelectorAll('.nav-link').forEach(button => {
          button.addEventListener('click', function() {
            // すべてのタブボタンから active クラスを削除
            document.querySelectorAll('.nav-link').forEach(btn => {
              btn.classList.remove('active');
            });

            // クリックされたボタンに active クラスを追加
            this.classList.add('active');

            // すべてのタブコンテンツを非表示
            document.querySelectorAll('.tab-pane').forEach(content => {
              content.classList.remove('show', 'active');
            });

            // クリックされたボタンのターゲットコンテンツを表示
            const targetId = this.getAttribute('href');
            document.querySelector(targetId).classList.add('show', 'active');

            // 業種内ジャンルランキングのタブが選択された場合
            if (targetId === '#type') {
              loadBusinessTypes('industrySelectType');
              updateTypeRanking();
            }

            // 平均稼働ランキングのタブが選択された場合
            if (targetId === '#ranking') {
              loadBusinessTypes('industrySelectRanking');
              updateRanking();
            }
          });
        });

        // 業種内ジャンルランキング更新
        function updateTypeRanking() {
          const selectedBizType = document.getElementById('industrySelectType').value;
          if (!selectedBizType) return;

          const tableBody = document.getElementById('typeTableBody');
          const chartCanvas = document.getElementById('typeChart');
          const loadingSpinner = document.querySelector('#type .spinner-border');

          // ローディング表示
          if (loadingSpinner) loadingSpinner.style.display = 'inline-block';

          // APIからデータを取得
          fetch(`/api/ranking/genre?biz_type=${encodeURIComponent(selectedBizType)}`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`API応答エラー: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              console.log('業種内ジャンルランキングデータ:', data);

              // テーブル表示
              tableBody.innerHTML = '';

              if (!Array.isArray(data) || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">該当するデータがありません</td></tr>';
                return;
              }

              data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${item.genre || '不明'}</td>
                  <td>${item.store_count}</td>
                  <td>${item.avg_rate}%</td>
                `;
                tableBody.appendChild(row);
              });

              // グラフ表示
              if (charts.type) charts.type.destroy();

              const ctx = chartCanvas.getContext('2d');
              charts.type = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: data.map(item => item.genre || '不明'),
                  datasets: [{
                    label: '平均稼働率 (%)',
                    data: data.map(item => item.avg_rate),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 100
                    }
                  },
                  plugins: {
                    title: {
                      display: true,
                      text: `「${selectedBizType}」業種内ジャンルの平均稼働率`,
                      font: {
                        size: 16
                      }
                    }
                  }
                }
              });
            })
            .catch(error => {
              console.error('ジャンルランキング取得エラー:', error);
              tableBody.innerHTML = '<tr><td colspan="4" class="text-center">データ取得中にエラーが発生しました</td></tr>';
              // エラーの詳細をコンソールに出力
              console.error('エラー詳細:', error.stack);
            })
            .finally(() => {
              // ローディング非表示
              if (loadingSpinner) loadingSpinner.style.display = 'none';
            });
        }

        // 業種選択変更時のイベント
        document.getElementById('industrySelectType')?.addEventListener('change', updateTypeRanking);

        // 平均稼働ランキング更新
        function updateRanking() {
          const rankingType = document.getElementById('rankingTypeSelect').value;
          const industryFilter = document.getElementById('industrySelectRanking');
          const tableBody = document.getElementById('rankingTable').querySelector('tbody');
          const loadingSpinner = document.querySelector('#ranking .spinner-border');

          // ローディング表示
          if (loadingSpinner) loadingSpinner.style.display = 'inline-block';

          // APIリクエストURL構築
          let url = '/api/ranking/average';
          if (rankingType === 'industry' && industryFilter.value) {
            url += `?biz_type=${encodeURIComponent(industryFilter.value)}`;
          }

          // データ取得
          fetch(url)
            .then(response => response.json())
            .then(data => {
              // テーブル更新
              tableBody.innerHTML = '';

              if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">該当するデータがありません</td></tr>';
              } else {
                data.forEach((item, index) => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.store_name}</td>
                    <td>${item.biz_type || '-'}</td>
                    <td>${item.genre || '-'}</td>
                    <td>${item.area || '-'}</td>
                    <td>${item.avg_rate.toFixed(1)}%</td>
                  `;
                  tableBody.appendChild(row);
                });
              }
            })
            .catch(error => {
              console.error('ランキングデータ取得エラー:', error);
              tableBody.innerHTML = '<tr><td colspan="6" class="text-center">データ取得中にエラーが発生しました</td></tr>';
            })
            .finally(() => {
              // ローディング非表示
              if (loadingSpinner) loadingSpinner.style.display = 'none';
            });
        }

        // ランキングタイプ変更時のイベント
        document.getElementById('rankingTypeSelect')?.addEventListener('change', function() {
          // 業種フィルタの表示/非表示切替
          const industryFilterDiv = document.getElementById('industryFilterDiv');
          if (this.value === 'industry') {
            industryFilterDiv.style.display = 'block';
          } else {
            industryFilterDiv.style.display = 'none';
          }
        });

        // ランキング更新ボタンのイベント
        document.getElementById('updateRankingBtn')?.addEventListener('click', updateRanking);

        function updateHistoryChart() {
          const storeId = document.getElementById('storeSelectHistory').value;
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          const historyStats = document.getElementById('historyStats');
          const spinner = document.querySelector('#history .spinner-border');

          // ローディング表示
          spinner.style.display = 'inline-block';
          historyStats.textContent = '読み込み中...';

          // 最適化: 集計済みデータを使用するかフィルタリングしたデータを使用するか決定
          let url;
          if (storeId || startDate || endDate) {
            // 特定店舗や期間指定の場合はフィルタリングしたデータを使用
            url = '/api/history?';
            if (storeId) {
              url += `store=${encodeURIComponent(storeId)}&`;
            }
            if (startDate) {
              url += `start_date=${encodeURIComponent(startDate)}&`;
            }
            if (endDate) {
              url += `end_date=${encodeURIComponent(endDate)}&`;
            }
            // サンプル数を制限してパフォーマンス改善
            url += 'limit=2000';
          } else {
            // 期間指定なしの場合は集計済みデータを使用
            url = '/api/aggregated';
          }

          fetch(url)
            .then(response => response.json())
            .then(data => {
              // 集計データの場合の処理
              if (url.includes('/api/aggregated')) {
                processAggregatedData(data);
                return;
              }

              // 通常データの場合の処理
              if (!data.length) {
                historyStats.textContent = '該当データがありません';
                spinner.style.display = 'none';
                return;
              }

              // データが存在する場合の処理
              const filteredData = data.filter(record =>
                record.working_staff > 0
              );

              if (filteredData.length === 0) {
                historyStats.textContent = '有効なデータがありません（出勤スタッフ0人の記録のみ）';
                spinner.style.display = 'none';
                return;
              }

              // 時系列データの作成 - ISO8601形式のタイムスタンプが正しく解析できる
              const labels = filteredData.map(record => {
                try {
                  // JavaScriptが正しく解析できる形式かチェック
                  const timestamp = record.timestamp;
                  // console.log('パース対象のタイムスタンプ:', timestamp);
                  return new Date(timestamp);
                } catch (e) {
                  console.error('タイムスタンプ解析エラー:', record.timestamp, e);
                  return null;
                }
              }).filter(date => date !== null);

              const effectiveRates = filteredData.map(record => {
                if (record.working_staff === 0) return null;
                // APIがrate値を直接提供している場合はそれを使用
                if (record.rate !== undefined) return record.rate;
                return ((record.working_staff - record.active_staff) / record.working_staff) * 100;
              });

              // サンプル数と平均値の計算
              const validRates = effectiveRates.filter(rate => rate !== null);
              const overallAvg = validRates.length > 0
                ? validRates.reduce((sum, rate) => sum + rate, 0) / validRates.length
                : 0;

              historyStats.textContent = `期間内サンプル数: ${validRates.length}件, 平均稼働率: ${overallAvg.toFixed(1)}%`;

              // グラフの描画
              const ctx = document.getElementById('historyChart').getContext('2d');

              // 既存のグラフがあれば破棄
              if (charts.history) {
                charts.history.destroy();
              }

              charts.history = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [{
                    label: '稼働率 (%)',
                    data: effectiveRates,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    pointRadius: 1,
                    borderWidth: 2
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    x: {
                      type: 'time',
                      time: {
                        unit: 'day',
                        tooltipFormat: 'yyyy/MM/dd HH:mm',
                        displayFormats: {
                          hour: 'MM/dd HH:mm'
                        }
                      },
                      title: {
                        display: true,
                        text: '日時'
                      }
                    },
                    y: {
                      beginAtZero: true,
                      max: 100,
                      title: {
                        display: true,
                        text: '稼働率 (%)'
                      }
                    }
                  },
                  plugins: {
                    title: {
                      display: true,
                      text: storeId ? `店舗「${storeId}」の稼働率推移` : '全店舗の平均稼働率推移',
                      font: {
                        size: 16
                      }
                    }
                  }
                }
              });

              spinner.style.display = 'none';
            })
            .catch(error => {
              console.error('履歴データ取得エラー:', error);
              historyStats.textContent = 'データ取得中にエラーが発生しました';
              spinner.style.display = 'none';
            });
        }

        function updateHourlyAnalysis() {
          const storeId = document.getElementById('hourlyStoreSelect').value;
          const hourlyStats = document.getElementById('hourlyStats');
          const spinner = document.querySelector('#hourly .spinner-border');

          // ローディング表示
          spinner.style.display = 'inline-block';
          hourlyStats.textContent = '読み込み中...';

          // データ取得URL
          let url = '/api/history';
          if (storeId) {
            url += `?store=${encodeURIComponent(storeId)}`;
          }

          fetch(url)
            .then(response => response.json())
            .then(data => {
              if (!data.length) {
                hourlyStats.textContent = '該当データがありません';
                spinner.style.display = 'none';
                return;
              }

              // 時間帯ごとのデータ集計
              const hourly = {};

              // 0-23時の初期化
              for (let h = 0; h < 24; h++) {
                hourly[h] = {
                  totalRate: 0,
                  count: 0
                };
              }

              // データ集計
              data.forEach(record => {
                if (record.working_staff <= 0) return;

                try {
                  const d = new Date(record.timestamp);
                  const hour = d.getHours();
                  const rate = ((record.working_staff - record.active_staff) / record.working_staff) * 100;

                  if (!isNaN(hour) && hour >= 0 && hour < 24) {
                    hourly[hour].totalRate += rate;
                    hourly[hour].count++;
                  }
                } catch (e) {
                  console.error('時間帯データ処理エラー:', e, record);
                }
              });

              // 平均計算
              const labels = [];
              const avgRates = [];

              for (let h = 0; h < 24; h++) {
                labels.push(`${h}:00`);

                if (hourly[h].count > 0) {
                  avgRates.push(hourly[h].totalRate / hourly[h].count);
                } else {
                  avgRates.push(0);
                }
              }

              // 平均稼働率の計算
              const totalSamples = Object.values(hourly).reduce((sum, h) => sum + h.count, 0);

              hourlyStats.textContent = `分析対象サンプル数: ${totalSamples}件`;
              spinner.style.display = 'none';

              // チャート描画
              const ctx = document.getElementById('hourlyChart').getContext('2d');

              // 既存のグラフがあれば破棄
              if (charts.hourly) {
                charts.hourly.destroy();
              }

              charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: labels,
                  datasets: [{
                    label: '平均稼働率 (%)',
                    data: avgRates,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 100,
                      title: {
                        display: true,
                        text: '稼働率 (%)'
                      }
                    },
                    x: {
                      title: {
                        display: true,
                        text: '時間帯'
                      }
                    }
                  },
                  plugins: {
                    title: {
                      display: true,
                      text: storeId ? `店舗「${storeId}」の時間帯別稼働率` : '全店舗の時間帯別平均稼働率',
                      font: {
                        size: 16
                      }
                    }
                  }
                }
              });
            })
            .catch(error => {
              console.error('時間帯データ取得エラー:', error);
              hourlyStats.textContent = 'データ取得中にエラーが発生しました';
              spinner.style.display = 'none';
            });
        }

        // 時間帯別分析の更新ボタンにイベントリスナーを追加
        document.getElementById("updateHourlyBtn")?.addEventListener("click", updateHourlyAnalysis);

        // ページ読み込み時のイベント
        document.addEventListener('DOMContentLoaded', function() {
          // グローバルエラーハンドリング
          window.addEventListener('error', function(e) {
            console.error('グローバルエラー:', e.message);
          });

          // 初期表示タブはタブ1
          document.getElementById('dashboard').classList.add('show', 'active');
          //document.querySelector('.nav-link[href="#dashboard"]').classList.add('active');

          // 店舗リストの読み込み
          loadStoreList();

          // 現在の稼働状況を読み込み
          fetchCurrentData();

          // 更新ボタンのイベントリスナーが設定されていることを確認
          console.log("イベントハンドラ設定確認:");
          const updateButtons = {
            "historyBtn": document.getElementById("updateHistoryBtn"),
            "hourlyBtn": document.getElementById("updateHourlyBtn"),
            "areaBtn": document.getElementById("updateAreaBtn"),
            "typeBtn": document.getElementById("industrySelectType"),
            "rankingBtn": document.getElementById("updateRankingBtn")
          };

          for (const [key, btn] of Object.entries(updateButtons)) {
            console.log(`${key}: ${btn ? "OK" : "未設定"}`);
            if (!btn && key !== "typeBtn") { // typeBtn はオプション
              console.warn(`警告: ${key} が見つかりません`);
            }
          }
        });
      });
    })();
  </script>
</body>
</html>